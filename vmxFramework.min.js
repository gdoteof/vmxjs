/* 
 vmxFramework_14b28d9-dirty
 Copyright 2013-2014 vision.ai, LLC. http://vision.ai/
*/
angular.module("vmx",["vmx.services","ui.bootstrap"]),angular.module("vmx.services",[]);var SERVER;SERVER="http://localhost:3000/";var vmxApi,VmxApi;!function(){"use strict";var a,b=!1,c={},d={};VmxApi=function(){return this};var e=function(a,b){this.detections=a,this.params=b},f=function(a,b,c){if(!d[a])return this;var e=d[a],f=b[0].score,g=e.onEnter;g&&f>=g.minScore&&((!g.lastMet||g.lastMet+g.minTime<=c)&&g.callback(g.params),g.lastMet=c);var h=e.onLeave;h&&f<h.minScore?(void 0===h.startedLeaving&&(h.startedLeaving=c),h.canFire&&h.startedLeaving+h.minTime<=c&&(h.canFire=!1,h.callback(h.params)),h.lastMet=c):h&&(h.canFire=!0,h.startedLeaving=void 0)},g=function(a,b,c,e,f){f||(f={});var g=f.minScore||.1,h=f.minTime||500,i=f.canFire;if(d[a]||(d[a]={}),d[a][b]={callback:c,params:e,minScore:g,minTime:h,lastMet:void 0,canFire:void 0},"onLeave"===b){var j=d[a].onEnter;(j&&j.lastMet||i)&&(d[a][b].canFire=!0)}};VmxApi.prototype.reset=function(){c={},d={}},VmxApi.prototype.select=function(a){return this.selector=a,a&&!(this.$selected=c[a])&&(this.$selected=null),this},VmxApi.prototype.processServerResponse=function(a){var b,d=a.detections,g=a.detectorParams,h=a.name||d[0].name,i=a.connectionId,j=(new Date).getTime();return f(h,d,j),(b=c[h])?b[i]=d:(b=new e(d,g),c[h]={},c[h][i]=b),this},VmxApi.prototype.onEnter=function(a,b,c){return g(this.selector,"onEnter",a,b,c),this},VmxApi.prototype.onLeave=function(a,b,c){return g(this.selector,"onLeave",a,b,c),this},VmxApi.prototype.everDetected=function(a){if(a){var b={name:"Too many parameters",message:"This functin takes no params!"};throw b}return null!==this.$selected&&!!this.$selected},VmxApi.prototype.getSelector=function(){return this.selector},VmxApi.prototype.params=function(a,b){var c=null;return c=null===b?!0:!1,console.log(this.$selected),this},vmxApi=function(c){return b||(a=new VmxApi,b=!0),c?a.select(c):a},vmxApi(),vmxApi.reset=a.reset,vmxApi.processServerResponse=a.processServerResponse,vmxApi.fn=VmxApi.prototype}(),angular.module("vmx").run(["$templateCache",function(a){"use strict";a.put("static/partial/externalSourceModal.html",'<div class="modal-header"><h3>Use external source</h3></div><div class="modal-body">Enter external source <input ng-model="input"><p>Note: you can enter an imagestream here; VMX will automatically refresh the image as appropriate to create a \'video\'</p><p>for example: http://192.168.0.178/snapshot.cgi?user=admin&pwd=123456&next_url=tempsnapshot.jpg&count= <a href="" class="btn btn-default btn-lg ng-click=" input="http://192.168.0.178/snapshot.cgi?user=admin&pwd=123456&next_url=tempsnapshot.jpg&count=">fill</a></p>Or, you can try a youtube video: <input ng-model="youtube_id"><a class="btn clickable" ng-click="doyoutube(youtube_id)">load youtube</a></div><div class="modal-footer"><button class="btn btn-primary" ng-click="ok(input)">OK</button> <button class="btn btn-warning" ng-click="cancel()">Cancel</button></div>'),a.put("static/partial/modalCheckLicense.html",'<div class="modal-header"><nav class="navbar navbar-default"><a class="navbar-brand">Unlicensed VMX</a></nav></div><div class="modal-body" ng-click="clicked=true"><div class="row"><div class="col-md-12"><div class="row"><div class="col-md-3 col-md-offset-2"><p><a class="btn btn-success btn-lg" target="buyWindow" href="{{buyLink}}">Buy VMX</a></p></div><div class="col-md-4 cold-md-offset-1"><p><a class="btn btn-success btn-lg" target="enterLicenseWindow" href="{{enterLink}}" ng-click="clicked=true">Enter License Key</a></p></div><div class="col-md-1 col-md-offset-1" ng-if="clicked"><p><a class="btn btn-success btn-lg" ng-click="check()"><span><i class="fa fa-refresh ng-class:{\'fa-spin\': spin}"></i></span></a></p></div></div></div></div></div>'),a.put("static/partial/modalProblemWithVMX.html",'<div class="modal-header"><nav class="navbar navbar-default"><a class="navbar-brand">Error running VMX Server</a></nav></div><div class="modal-body"><div class="row"><div class="col-md-12"><strong>Error Message:</strong> {{errorMessage}}</div></div></div><div class="modal-footer"><button class="btn btn-success btn-lg" ng-click="cancel()">Okay</button></div>'),a.put("static/partial/modelEditorModal.html",'<div class="modal-header"><nav class="navbar navbar-default"><a class="navbar-brand">Advanced Model Editor</a><ul class="nav navbar-nav navbar-right"><li><a class="btn btn-default navbar-right" ng-click="cancel()"><i class="fa fa-times"></i></a></li></ul></nav></div><div class="modal-body"><div class="row"><div class="col-md-4"><strong>Instructions:</strong> Click on an object to swap sides. The goal is to take bad positives and move them to the negative side. Remember to save the model after you\'re done.</div><div class="col-md-3"><button class="btn btn-primary ladda-button" id="update_model_button" data-style="zoom-in" ng-click="submit_stuff()"><span class="ladda-label">Update Model</span></button></div><div class="col-md-3"><div class="input-group"><span class="input-group-addon">Learning Iterations</span> <input class="form-control" ng-model="settings.learn_iterations" type="number"></div></div></div><br><div class="row"><div class="col-md-6 positives" style="text-align:center"><div class="well"><div ng-if="container.objects"><h4>Positives ({{filteredpos.length}})</h4><div class="row"><div class="col-xs-3"><div class="form-group"><label><small>Total</small></label><input class="form-control" type="number" ng-model="settings.max_positives"></div></div><div class="col-xs-3"><div class="form-group"><label><small>Sort Order</small></label><input class="form-control" type="number" ng-model="settings.positives_order"></div></div><div class="col-xs-3"><div class="form-group"><label><small>Lowest Score</small></label><input class="form-control" ng-model="pos.lowest"></div></div><div class="col-xs-3"><div class="form-group"><label><small>Max Score</small></label><input class="form-control" ng-model="pos.highest"></div></div></div><div class="row"><div class="col-md-3 thumbnail-container magic-animate apositive" ng-repeat="object in filteredpos = (container.objects | classIs: 1 | orderBy:\'score\' |  scoreIs:\'>\':pos.lowest | scoreIs: \'<\': pos.highest)"><vmx-image-crop score="object.score" image="{{object.image}}" time="{{object.time}}" class="object.class_label"></vmx-image-crop></div></div></div></div></div><div class="col-md-6 negatives" style="text-align:center"><div class="well"><div ng-if="container.objects"><h4>Negatives ({{filteredneg.length}})</h4><div class="row"><div class="col-xs-3"><div class="form-group"><label><small>Total</small></label><input class="form-control" type="number" ng-model="settings.max_negatives"></div></div><div class="col-xs-3"><div class="form-group"><label><small>Sort Order</small></label><input class="form-control" type="number" ng-model="settings.negatives_order"></div></div><div class="col-xs-3"><div class="form-group"><label><small>Lowest Score</small></label><input class="form-control" ng-model="neg.lowest"></div></div><div class="col-xs-3"><div class="form-group"><label><small>Max Score</small></label><input class="form-control" ng-model="neg.highest"></div></div></div><div class="row"><div class="col-md-3 thumbnail-container magic-animate anegative" ng-repeat="object in filteredneg  = (container.objects | orderBy:\'score\':reverse | scoreIs:\'>\':neg.lowest | scoreIs: \'<\': neg.highest | classIs:-1)"><vmx-image-crop score="object.score" image="{{object.image}}" time="{{object.time}}" class="object.class_label"></vmx-image-crop></div></div></div></div></div></div></div><div class="modal-footer"><button class="btn btn-warning" ng-click="cancel()">Cancel</button></div>'),a.put("static/partial/modelLoaderModal.html",'<div class="modal-header"><nav class="navbar navbar-default"><a class="navbar-brand">Model Library</a><ul class="nav navbar-nav navbar-right"><li><a class="btn btn-default navbar-right" ng-click="cancel()"><i class="fa fa-times"></i></a></li></ul></nav></div><div class="modal-body"><div class="row"><div ng-repeat="model in models" class="col-md-2" ng-click="choose(model)" class="clickable"><vmx-detector-thumbnail model="model"></vmx-detector-thumbnail></div></div></div><div class="modal-footer"><button class="btn btn-warning" ng-click="cancel()">Cancel</button></div>'),a.put("static/partial/vmxAvailableDetectors.html",'<div class="panel" style="box-shadow: 0 0 12px black"><div class="input-group"><span class="input-group-btn" ng-if="!search.id"><a ng-click="choose_model()" data-style="zoom-in" class="btn btn-primary detector-chooser-spinner ladda-button"><span><i class="fa fa-folder-open"></i></span> Load Model</a></span> <span class="input-group-btn" ng-if="search.id"><button ng-click="addDetector(search)" class="btn btn-default">attach {{search.model.name}} detector ({{search.id}})</button></span> <input id="detector-chooser-input" class="form-control" placeholder="Search existing detectors..({{all_available_connections.length}})" ng-model="search" typeahead="c as c.model.name for c in all_available_connections | modelNameContains : search" typeahead-input-formatter="format()"></div><ul class="list-inline" style="height:18px;overflow:hidden;margin-bottom:0px"><li ng-repeat="t in top_detectors" ng-click="addDetector(t)" class="clickable">{{t.model.name}}</li></ul></div>'),a.put("static/partial/vmxCreateModel.html",'<div class="panel" style="box-shadow: 0 0 12px black"><div class="panel dragbar"><a class="btn btn-default close" ng-click="toggle(\'createModel\')"><i class="fa fa-times fa-inverse"></i></a><div class="row"><div class="col-md-4"><h4><span><i class="fa fa-eye"></i></span> Create Model</h4></div></div></div><div class="row"><div class="col-md-6"><div class="list-group"><div class="list-group-item"><div class="input-group"><input class="form-control" ng-model="model_name" placeholder="Enter Object Name" id="create_model_text"> <span class="input-group-btn"><button class="btn btn-primary ladda-button" ng-class="(has_selections() && is_valid_name(model_name)) ? \'\' : \'disabled\'" id="create_model_button" data-style="zoom-in" ng-click="create_model(model_name);">Create Model <span class="fa fa-flask"></span></button></span></div><span class="text-danger">{{error_message}}</span></div></div></div><div class="col-md-6"><vmx-detector-params showbutton="false" to-include="[\'init\']" params="paramsObj"></vmx-detector-params></div></div><div class="row"><div class="col-md-4"><div class="btn-group btn-group-justified"><a class="btn btn-default clickable" ng-class="(selections.length>0) ? \'\' : \'disabled\'" ng-click="container.show_selections = !container.show_selections">{{(container.show_selections) ? \'Hide Selections\' : \'Show Selections (\'+selections.length+\')\'}}</a> <a class="btn btn-info clickable" ng-click="toggle_selection_mode()">Add Selection <small>(press A)</small></a></div></div></div><div class="well" ng-if="container.show_selections"><div class="row"><div class="col-md-3" ng-animate="\'animate\'" ng-repeat="selection in selections"><div class="thumbnail"><caption><div style="text-align:center"><small>Selection {{$index}}</small></div><img ng-src="{{selection.objects[0].icon}}" style="height:80px; align:center"><div style="text-align:center"><small><strong>Time:</strong>{{selection.time}}<br><a class="btn btn-primary btn-xs" ng-click="remove_selection($index)">Remove <i class="fa fa-times"></i></a></small></div></caption></div></div></div></div></div>'),a.put("static/partial/vmxDebugPanel.html",'<div class="panel" ng-init="container.debug_index = 0" style="box-shadow: 0 0 12px black"><div class="panel dragbar"><a class="btn btn-default close" ng-click="toggle(\'debugOutput\')"><i class="fa fa-times fa-inverse"></i></a><div class="row"><div class="col-md-9"><h4><span><i class="fa fa-bug"></i></span> Debug Output</h4></div></div></div><div class="btn-group"><a class="dropdown-toggle btn btn-default clickable" data-toggle="dropdown">Detectors <span class="caret"></span></a><ul class="dropdown-menu"><li ng-repeat="detector in running_detectors"><a class="clickable" ng-click="container.debug_index = $index">{{detector.connection.model.name}}</a></li></ul></div><div class="pane-container"><h5>{{running_detectors[container.debug_index].connection.model.name}}</h5><vmx-json-pane binding="running_detectors[container.debug_index].short_response"></vmx-json-pane></div></div>'),a.put("static/partial/vmxDetectorParam.html",'<div ng-init="paramcontainer={};paramcontainer.collapse=true" class="param-label-container"><label for="{{param.name}}" class="clickable" ng-click="paramcontainer.collapse = !paramcontainer.collapse; checker(\'top\');"><small ng-class="(param.learning_mode==false && paramsObj.get(\'learn_mode\')==true) ? \'disabled-text\' : \'\'">{{param.alias}} <i ng-class="(paramcontainer.collapse) ? \'fa fa-caret-right\' : \'fa fa-caret-down\'"></i></small></label></div><form role="form" ng-if="!paramcontainer.collapse && (param.learning_mode==true || paramsObj.get(\'learn_mode\')==false)"><div class="control-group" ng-class="(param.current_value==param.value) ? \'success\' : \'warning\'"><div class="form-group"><div class="row" ng-if="param.widget == \'checkbox\'"><div class="col-md-3"><div class="input-group input-group-sm"><span class="input-group-addon"><input type="checkbox" ng-model="param.current_value"></span><div class="form-control">{{(param.current_value) ? \'On\' : \'Off\'}}</div></div></div></div><div class="row" ng-if="param.widget ==\'slider\'"><div class="col-md-12"><input class="form-control input-sm" ng-model="param.current_value"></div><div class="col-md-3"><slider min="param.min_value" max="param.max_value" step-size="{{param.slider_step}}" value="param.current_value"></slider></div></div></div></div></form>'),a.put("static/partial/vmxDetectorParams.html",'<div class="thumbnail"><h5>Parameters</h5><div class="btn-toolbar" role="toolbar"><div class="btn-group btn-group-sm" ng-if="update_button"><a class="btn btn-primary" ng-class="{\'disabled\':saving_mode}" ng-click="update_current_parameters()">Update Parameters</a></div><div class="btn-group btn-group-sm" ng-if="update_button"><a class="btn btn-default" ng-click="expand_all_params()"><i class="fa" ng-class="(collapse_state) ? \'fa-plus-square\' : \'fa-minus-square\'"></i></a></div></div><vmx-detector-param param="param" ng-repeat="param in params | includeParams: toInclude()"></vmx-detector-param></div>'),a.put("static/partial/vmxDetectorThumbnail.html",'<div class="thumbnail clickable"><caption><h4 class="inline" style="text-align:center">{{model.name}}</h4><img ng-if="model.image" ng-src="{{model.image}}" style="height:100px; align:center" data-toggle="tooltip" data-placement="right" title="{{model.uuid}}"><div style="text-align:center"><small><strong>#pos:</strong> {{model.num_pos}} / <strong>#neg:</strong> {{model.num_neg}}<br><strong>Size:</strong> {{model.size[0]}}x{{model.size[1]}}<br><strong>Start:</strong> {{model.start_time}}<br><strong>End:</strong> {{model.end_time}}</small></div></caption></div>'),a.put("static/partial/vmxEditorPane.html",'<div class="well"><nav class="navbar navbar-default"><a class="navbar-brand">Code Window</a><ul class="nav navbar-nav navbar-right"><li><a class="btn btn-default btn-xs navbar-right" ng-click="vmxui.container.editor_visible = !vmxui.container.editor_visible"><i class="glyphicon glyphicon-remove"></i></a></li></ul></nav><div class="btn-group"><a class="btn" href=""><i class="glyphicon-cog glyphicon"></i> Apps</a> <a class="btn dropdown-toggle" data-toggle="dropdown" href=""><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="" ng-click="new_app_modal()"><i class="glyphicon-pencil"></i> New App</a></li><li class="dropdown-submenu"><a href="">Open App</a><ul class="dropdown-menu"><li ng-repeat="entity_app in container.apps"><a href="" ng-click="set_current_app($index)">{{entity_app.value.name}}</a></li></ul></li><li ng-if="current_app"><a href="" ng-click="save_current_app()">Save App {{current_app.value.name}}</a></li><li class="dropdown-submenu"><a href=""><i class="glyphicon-trash"></i>Delete App</a><ul class="dropdown-menu"><li ng-repeat="entity_app in container.apps"><a href="" ng-click="delete_app($index)">Delete: {{entity_app.value.name}}</a></li></ul></li></ul></div><div ng-if="current_app" class="btn-group"><a class="btn" href=""><i class="glyphicon-file glyphicon-black"></i> Code</a> <a class="btn dropdown-toggle" data-toggle="dropdown" href=""><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="" ng-click="switch_buffer(\'callback\')"><i class="glyphicon-important"></i> Callback</a></li><li class="divider"></li><li><a href="" ng-click="new_file_modal()"><i class="glyphicon-pencil"></i> New File</a></li><li class="dropdown-submenu"><a href="">Open File</a><ul class="dropdown-menu"><li ng-repeat="file in files"><a href="" ng-click="switch_buffer($index)">{{file.name}}</a></li></ul></li><li class="dropdown-submenu"><a href=""><i class="glyphicon-trash"></i>Delete File</a><ul class="dropdown-menu"><li ng-repeat="file in files"><a href="" ng-click="delete_file($index)">Delete File: {{file.name}}</a></li></ul></li><li class="seperator"></li><li class="dropdown-submenu"><a href="">Set Keybinding</a><ul class="dropdown-menu"><li><a href="" ng-click="set_keybinding(\'vim\')">Vim<i ng-if="container.keybinding == \'vim\'" class="glyphicon-ok"></i></a></li><li><a href="" ng-click="set_keybinding(\'emacs\')">Emacs<i ng-if="container.keybinding == \'emacs\'" class="glyphicon-ok"></i></a></li><li><a href="" ng-click="set_keybinding()">Normal<i ng-if="!container.keybinding" class="glyphicon-ok"></i></a></li></ul></li></ul></div><div ng-if="!current_app"><div class="well"><p>Please open an app to get started</p></div></div><div ng-if="current_app"><div class="above-editor-container clearfix"><span class="pull-left">Currently editing: {{currently_editing}}</span> <span class="pull-right">Run code<input type="checkbox" ng-model="switches.run_code_switch"></span></div><div id="editor-container" class="clearfix" width="100%"><div class="ace_editor" style="height:200px" ui-ace="{onLoad : aceLoaded, mode: \'javascript\'}" ng-model="container.script_in_editor"></div><button ng-if="current_file_index && current_file_index !=\'callback\'" class="btn btn-{{compile_status();}}" ng-click="save_file(current_file_index)">Save File {{currently_editing}}</button> <button ng-if="current_file_index==\'callback\'" ng-class="(container.buffers_edited_ns[\'callback\']) ? \'btn btn-primary\' : \'btn\'" ng-click="save_callback(container.script_in_editor)">Compile and Save callback</button> <span ng-if="container.buffers_edited_ns[\'callback\'] && current_file_index == \'callback\'">Callback not saved</span></div></div></div>currently_editing = {{currently_editing}} current_file_index'),a.put("static/partial/vmxGitPane.html",'<div class="panel" style="box-shadow:0 0 12px black"><div class="panel dragbar"><a class="btn btn-default close" ng-click="toggle(\'gitApps\')"><i class="fa fa-times fa-inverse"></i></a><h4><span><i class="fa fa-github-alt"></i></span> Git</h4></div><div class="col-md-12">Run code<input type="checkbox" ng-model="switches.run_code_switch"><p>Enter a GitHub Repository which uses the VMX Api:</p></div><div class="input-group col-md-12"><span class="input-group-btn"><button class="clickable btn btn-default" ng-click="load_git_repo(gitrepo)">Load Git Repo</button></span> <input class="form-control" size="" ng-model="gitrepo"></div><div class="col-md-12"><ul><li ng-repeat="repo in repos"><a ng-click="setrepo(repo)" class="clickable">{{repo.name}}</a></li></ul><div class="alert alert-error" ng-repeat="error in container.errors">In file: {{error.file}} (line:{{error.line}})<pre>{{error.error}}</pre></div><a href="" ng-click="clear()" class="btn btn-default btn-xs clickable">Reset</a></div></div>'),a.put("static/partial/vmxImageCrop.html",'<div class="thumbnail" style="text-align:center" ng-class="(class>0) ? \'alert-success\' : \'alert-danger\'" ng-click="class=class*-1"><img ng-src="{{image}}" style="height:80%; width:80%"><caption><small><strong>Score:</strong>{{score.toFixed(2)}}<br><strong>Time:</strong>{{time}}<br></small> <a class="btn btn-xs btn-primary"><span ng-class="class<0 ? \'fa fa-arrow-left\' : \'fa fa-arrow-right\'"></span></a></caption></div>'),a.put("static/partial/vmxIpCam.html",'<canvas class="video-drawing-canvas" id="{{camId}}" ng-class="selection_mode ? \'pointer_crosshair\' : \'pointer_default\'" style="position:absolute;top:0px;left:0px;z-index:3;width:100%"></canvas>'),a.put("static/partial/vmxOverlay.html",'<div ng-if="g.is_playing" class="col-md-12" id="overlay-container" style="position:absolute;top:0px;left:0px;z-index:10;opacity:.85"><div class="row"><div class="col-xs-11 col-md-11 col-lg-11" id="vmx-command-overlay"><div class="row"><vmx-overlay-content></vmx-overlay-content></div></div><div class="col-xs-1 col-md-1 col-lg-1" id="overlay-column" style="background:white;overflow:hidden"><div class="row"><vmx-overlay-toolbar></vmx-overlay-toolbar></div></div></div></div>'),a.put("static/partial/vmxOverlayContent.html",'<div class="col-md-12" ng-if="ui.panels.availableDetectors" ng-show="!selectionMode()"><vmx-available-detectors></vmx-available-detectors></div><div class="col-md-12 dbar" ng-if="ui.panels.gitApps" ng-show="!selectionMode()"><vmx-git-pane></vmx-git-pane></div><div class="col-md-12 dbar" ng-if="ui.panels.createModel" ng-show="!selectionMode()"><vmx-create-model></vmx-create-model></div><div class="col-md-3 dbar" ng-if="ui.panels.runningDetectors" ng-show="!selectionMode()"><vmx-running-detectors></vmx-running-detectors></div><div class="col-md-4 dbar" ng-if="ui.panels.debugOutput" ng-show="!selectionMode()"><vmx-debug-panel></vmx-debug-panel></div>'),a.put("static/partial/vmxOverlayToolbar.html",'<div class="row vmx-vert-toolbar text-center"><div class="col-xs-11 col-md-11 col-lg-11"><div class="clickable toolbar-button" ng-class="(panel_state(\'availableDetectors\')) ? \'toolbar-selected\' : \'\'" ng-click="toggle(\'availableDetectors\')" style="overflow:none"><span><i class="fa fa-2x fa-plus fa-fw"></i></span></div><div class="clickable toolbar-button" ng-class="(panel_state(\'createModel\')) ? \'toolbar-selected\' : \'\'" ng-click="toggle(\'createModel\')" style="overflow:none"><span><i class="fa fa-2x fa-eye"></i></span></div><div class="clickable toolbar-button" ng-class="(panel_state(\'runningDetectors\')) ? \'toolbar-selected\' : \'\'" ng-click="(running_detectors.length>0) ? toggle(\'runningDetectors\') : \'\'" style="overflow:none"><span><i class="fa fa-2x fa-fw" ng-class="(running_detectors.length) ? \'fa-list\' : \'fa-ban disabled\'"></i></span></div><div class="clickable toolbar-button" ng-class="(panel_state(\'debugOutput\')) ? \'toolbar-selected\' : \'\'" ng-click="(running_detectors.length>0) ? toggle(\'debugOutput\') : \'\'" style="overflow:none"><span><i class="fa fa-2x fa-fw" ng-class="(running_detectors.length) ? \'fa-bug\' : \'fa-ban disabled\'"></i></span></div><div class="clickable toolbar-button" ng-class="(panel_state(\'gitApps\')) ? \'toolbar-selected\' : \'\'" ng-click="toggle(\'gitApps\')" style="overflow:none"><span><i class="fa fa-2x fa-github-alt fa-fw"></i></span></div></div></div>'),a.put("static/partial/vmxRunningDetectors.html",'<div class="panel" style="box-shadow:0 0 12px black"><div class="panel dragbar"><a class="btn btn-default close" ng-click="toggle(\'runningDetectors\')"><i class="fa fa-times fa-inverse"></i></a><h4><span><i class="fa fa-list"></i></span> Detectors({{running_detectors.length}})</h4></div><div ng-init="collapsers=[];params_collapse=[] " class="list-group"><div class="list-group-item" ng-repeat="d in running_detectors"><button type="button" class="close" title="Detach Detector" ng-click="removeDetector(d.connection.id,$index)"><i class="fa fa-external-link"></i></button><div class="inner clickable" ng-click="collapsers[$index] = !collapsers[$index]" ng-init="collapsers[$index]=true; params_collapse[$index]=true"><label>{{d.connection.model.name}} <i class="fa" ng-class="{\'fa-caret-right\':collapsers[$index],\'fa-caret-down\':!collapsers[$index]}"></i></label><div class="detector-collapse-container" ng-if="!collapsers[$index]"><vmx-detector-thumbnail model="d.connection.model"></vmx-detector-thumbnail></div></div><div class="detector-collapse-params" ng-if="!collapsers[$index]"><div class="btn-group btn-group-xs btn-group-justified"><a class="btn" ng-class="{\'btn-success\':d.params.getLearningMode(), \'btn-info\':!d.params.getLearningMode(), \'disabled\':saving_mode}" ng-click="toggle_learning_mode($index)">Learning Mode&nbsp; <i class="fa" ng-class="(d.params.getLearningMode()) ? \' fa-check-square-o\' : \'fa-square-o\'"></i></a></div><div class="btn-group btn-group-xs btn-group-justified"><a class="btn btn-default ladda-button" ng-class="(d.params.getLearningMode()) ? \'disabled\' : \'\'" data-style="zoom-in" id="save_model_button{{$index}}" ng-click="save_model(d.connection,\'save_model_button\'+$index)">Save Model <i class="fa fa-save"></i></a></div><div class="param-expander-container"><div class="btn-group btn-group-xs btn-group-justified"><a class="btn btn-default" ng-class="{\'disabled\':saving_mode}" ng-click="params_collapse[$index] = !params_collapse[$index]">Params&nbsp; <i class="fa" ng-class="{\'disabled\':d.params.getLearningMode()||saving_mode, \'fa-caret-right\':(params_collapse[$index]),\'fa-caret-down\':(!param_collapse[$index])}"></i></a> <a class="btn btn-default" ng-class="(d.params.getLearningMode()||saving_mode) ? \'disabled\' : \'\'" ng-click="displayModelEditorModal(d.connection)">Edit <i class="fa fa-pencil-square-o"></i></a></div></div><div ng-if="!params_collapse[$index]"><vmx-detector-params to-include="[\'det\']" params="d.params"></vmx-detector-params></div></div></div></div></div>'),a.put("static/partial/vmxTracker.html",'<canvas class="video-drawing-canvas" id="{{trackerId}}" ng-class="selection_mode ? \'pointer_crosshair\' : \'pointer_default\'" style="position:absolute;top:0px;left:0px;z-index:4"></canvas>'),a.put("static/partial/vmxVideo.html",'<div class="row" id="main-video-container"><div class="col-md-12 col-lg-12 video-element-container" id="{{videoId}}-container"><video id="{{videoId}}" style="left:0;top:0;z-index=0;-webkit-transform: scale(-1,1);width:100%"></video></div><div class="col-md-12 col-lg-12 drawing-canvas-container" style="position:absolute;top:0px;left:0px;z-index:4"><canvas class="video-drawing-canvas" id="{{canvasId}}" ng-class="selection_mode ? \'pointer_crosshair\' : \'pointer_default\'" style="position:absolute;top:0px;left:0px;z-index:4"></canvas><vmx-tracker></vmx-tracker></div></div>'),a.put("static/partial/vmxapi-magic-canvas-modal.html",'<div class="modal-header"><h3>Canvas Play Area</h3></div><div class="modal-body"><canvas id="magic-canvas" style="width:100%;height:400px"></canvas></div><div class="modal-footer"><button class="btn btn-warning" ng-click="cancel()">Cancel</button></div>')}]);var Detection;Detection=function(a,b,c,d,e,f,g,h,i,j){this.name=a,this.score=b,this.x=c,this.x1=c,this.x2=e,this.w=e-c,this.y=d,this.y1=d,this.y2=f,this.h=f-d,this.fill=g,this.color=h,this.ilearn_class=j,this.line_width=3,this.time=i?i:new Date,this.inside=function(a,b,c){return c=0|c,a>=this.x1-c&&a<=this.x2+c&&b>=this.y1-c&&b<=this.y2+c},this.draw=function(a){a.save();var b=[1,0,0],c=[0,1,0],d=this.score;d>1&&(d=1),-1>d&&(d=-1),d=(d+1)/2;for(var e=[0,0,0],f=0;3>f;++f)e[f]=b[f]*(1-d)+c[f]*d,e[f]=Math.round(255*e[f]);var g=e;if(this.color="rgba("+g[0]+","+g[1]+","+g[2]+",1.0)",this.fillStyle=this.color,this.ilearn_class&&0!==this.ilearn_class&&(a.lineWidth=0,a.fillStyle=1===this.ilearn_class?"rgba(0,255,0,0.1)":"rgba(255,0,0,0.1)",a.strokeStyle="rgb(0,0,0)",a.fillRect(this.x,this.y,this.w,this.h)),a.fillStyle=this.color,a.lineWidth=this.score<-1?this.line_width:this.line_width,a.strokeStyle=this.color,a.strokeRect(this.x,this.y,this.w,this.h),this.line_width>1&&this.name){var h=this.name+":"+this.score.toFixed(2);a.font="10px Courier";var i=a.measureText(h).width,j=10;a.strokeStyle=this.color,a.fillRect(this.x,this.y-j,i,j),a.strokeRect(this.x,this.y-j,i,j),a.fillStyle="rgb(0,0,0)",a.fillText(h,this.x,this.y-a.lineWidth)}a.restore()}};var GridTracker;GridTracker=function(a,b){"use strict";function c(a,b,c,d){a.beginPath(),a.arc(b,c,4|d,0,2*Math.PI,!0),a.closePath(),a.fill()}function d(a){return a*a}function e(a){var b=a.length,c={};if(c.std=1,c.mean=0,0===b)return c;for(var d=0,e=0,f=0;b>f;++f)d+=a[f],e+=a[f]*a[f];var g=d/b,h=e/b-g*g;return c.std=Math.sqrt(h),c.mean=g,c}function f(a,b,c,d){var f=e(a),g=e(c),h=e(b),i=e(d),j=g.std/f.std,k=i.std/h.std;j=(j+k)/2,k=j,a.length<4&&(j=1,k=1);var l=1.05,m=1/l;j>l&&(j=l),k>l&&(k=l),m>j&&(j=m),m>k&&(k=m);var n=g.mean-f.mean,o=i.mean-h.mean,p={};return p.x_1=f,p.y_1=h,p.x_2=g,p.y_2=i,p.s_1=j,p.s_2=k,p.dx=n,p.dy=o,p}function g(a,b,e){this.bb=a,this.time_history=[],this.point_history=[],this.iteration=1,this.max_size=b*e,this.point_count=b*e,this.point_status=new Uint8Array(this.max_size),this.prev_xy=new Float32Array(2*this.max_size),this.curr_xy=new Float32Array(2*this.max_size),this.grid_points=new Array(b);var g,h;for(g=0;b>g;++g)this.grid_points[g]=new Array(e);var i=a.x1,j=a.y1,k=a.x2,l=a.y2,m=(k-i)/(b-1),n=(l-j)/(e-1);1===b&&(m=0),1===e&&(n=0);var o=0,p=0;for(g=0;b>g;++g)for(h=0;e>h;++h){var q=i+m*g,r=j+n*h;this.curr_xy[p]=q,this.curr_xy[p+1]=r,p+=2,this.grid_points[g][h]={},this.grid_points[g][h].index=o,this.grid_points[g][h].error=0,this.grid_points[g][h].num_good=1,this.grid_points[g][h].is_valid=1,o+=1}this.move_bb=function(a){var b=a;if(1===this.time_history.length)return b;var c,d,e,g,h,i,j,k=[],l=[],m=[],n=[],o=!0;for(c=0;c<this.grid_points.length;++c)for(d=0;d<this.grid_points[c].length;++d)e=this.grid_points[c][d].index,g=this.prev_xy[2*e],h=this.prev_xy[2*e+1],i=this.curr_xy[2*e],j=this.curr_xy[2*e+1],b&&(o=a.inside(g,h)),o&&(k.push(g),l.push(h),m.push(i),n.push(j));var p=f(k,l,m,n);return b.x1=p.s_1*(b.x1-p.x_1.mean)+p.x_1.mean+p.dx,b.x2=p.s_1*(b.x2-p.x_1.mean)+p.x_1.mean+p.dx,b.y1=p.s_2*(b.y1-p.y_1.mean)+p.y_1.mean+p.dy,b.y2=p.s_2*(b.y2-p.y_1.mean)+p.y_1.mean+p.dy,k.length<3&&console.log("WARNING: only",k.length,"grid points inside detection"),new Detection(b.name,b.score,b.x1,b.y1,b.x2,b.y2,b.fill,b.color,b.time)},this.propagate_det=function(a,b){for(var c=this.time_history.map(function(a){return Math.abs(a-b)}),d=Math.min.apply({},c),e=c.indexOf(d),g=this.point_history[e],h=this.point_history[this.point_history.length-1],i=[],j=[],k=[],l=[],m=0;m<this.grid_points.length;++m)for(var n=0;n<this.grid_points[m].length;++n){var o=this.grid_points[m][n].index,p=g[2*o],q=g[2*o+1],r=h[2*o],s=h[2*o+1];a.inside(p,q)&&(i.push(p),j.push(q),k.push(r),l.push(s))}var t=f(i,j,k,l);a.x1=t.s_1*(a.x1-t.x_1.mean)+t.x_1.mean+t.dx,a.x2=t.s_1*(a.x2-t.x_1.mean)+t.x_1.mean+t.dx,a.y1=t.s_2*(a.y1-t.y_1.mean)+t.y_1.mean+t.dy,a.y2=t.s_2*(a.y2-t.y_1.mean)+t.y_1.mean+t.dy;var u=new Detection(a.name,a.score,a.x1,a.y1,a.x2,a.y2,a.fill,a.color,a.time);return u.line_width=a.line_width,u},this.pre_track=function(){var a=this.prev_xy;this.prev_xy=this.curr_xy,this.curr_xy=a},this.add_to_history=function(a){this.time_history.push(a);for(var b=new Array(this.curr_xy.length),c=0;c<this.curr_xy.length;++c)b[c]=this.curr_xy[c];this.point_history.push(b.slice(0)),this.time_history.length>w&&(this.time_history.pop(),this.point_history.pop())},this.increment_valid_counter=function(){var a,b,c,d=-1;for(a=0;a<this.grid_points.length;++a)for(b=0;b<this.grid_points[a].length;++b)c=this.grid_points[a][b].index,1===this.point_status[c]&&1===this.grid_points[a][b].is_valid&&this.grid_points[a][b].num_good++,this.grid_points[a][b].num_good>d&&(d=this.grid_points[a][b].num_good);return this.iteration=this.iteration+1,d},this.learn_xform=function(){if(0!==this.point_count){var a,b,c=new jsfeat.motion_model.affine2d,d=new jsfeat.matrix_t(3,3,jsfeat.F32_t|jsfeat.C1_t),e=[],f=[],g=0,h=0;
for(a=0;a<this.grid_points.length;++a)for(b=0;b<this.grid_points[a].length;++b)h=this.grid_points[a][b].index,1===this.point_status[h]&&1===this.grid_points[a][b].is_valid&&(e[g]={x:this.prev_xy[2*h],y:this.prev_xy[2*h+1]},f[g]={x:this.curr_xy[2*h],y:this.curr_xy[2*h+1]},g++);if(!(3>g)){c.run(e,f,d,g);var i=d.data;return isNaN(i[0])?void console.log("isnan in xform estimation"):i}}},this.learn_rigid=function(a){if(0!==this.point_count){for(var b,c=[],d=[],e=0,f=0,g=0;g<this.grid_points.length;++g)for(var h=0;h<this.grid_points[g].length;++h)f=this.grid_points[g][h].index,b=!0,a&&(b=a.inside(this.prev_xy[2*f],this.prev_xy[2*f+1]),b&&(this.grid_points[g][h].is_valid=1)),b&&(c[e]={x:this.prev_xy[2*f],y:this.prev_xy[2*f+1]},d[e]={x:this.curr_xy[2*f],y:this.curr_xy[2*f+1]},e++);if(console.log("vc is ",e),!(3>e)){var i=this.std_dev2(c.map(function(a){return a.x})),j=this.std_dev2(d.map(function(a){return a.x})),k=this.std_dev2(c.map(function(a){return a.y})),l=this.std_dev2(d.map(function(a){return a.y})),m=new Array(9);return m[0]=j.std/i.std,m[1]=0,m[2]=j.mean-m[0]*i.mean,m[3]=0,m[4]=l.std/k.std,m[5]=l.mean-m[4]*k.mean,m[6]=0,m[7]=0,m[8]=1,isNaN(m[0])?void console.log("isnan in xform estimation"):m}}},this.xform_errors=function(){var a=this.learn_rigid();if(a){var b,c,e,f;for(b=0;b<this.grid_points.length;++b)for(c=0;c<this.grid_points[b].length;++c)e=this.grid_points[b][c].index,f=d(this.curr_xy[2*e]-a[0]*this.prev_xy[2*e]-a[1]*this.prev_xy[2*e+1]-a[2])+d(this.curr_xy[2*e+1]-a[3]*this.prev_xy[2*e]-a[4]*this.prev_xy[2*e+1]-a[5]),this.grid_points[b][c].error=Math.sqrt(f);return a}},this.apply_xform_to_current=function(a){if(a){var b,c,d,e,f,g,h,i;for(b=0;b<this.point_count;++b)c=this.prev_xy[2*b],d=this.prev_xy[2*b+1],e=this.curr_xy[2*b],f=this.curr_xy[2*b+1],g=a[0]*c+a[1]*d+a[2],h=a[3]*c+a[4]*d+a[5],i=Math.sqrt((c-g)*(c-g)+(d-h)*(d-h)),this.curr_xy[2*b]=g,this.curr_xy[2*b+1]=h}},this.draw_grid=function(a,b){if(this.grid_points&&this.grid_points[0]){var d,e,f,g;if(b.show_grid){for(a.beginPath(),d=0;d<this.grid_points.length;++d)for(e=0;e<this.grid_points[d].length-1;++e)f=this.grid_points[d][e].index,g=this.grid_points[d][e+1].index,a.moveTo(this.curr_xy[2*f],this.curr_xy[2*f+1]),a.lineTo(this.curr_xy[2*g],this.curr_xy[2*g+1]);for(d=0;d<this.grid_points.length-1;++d)for(e=0;e<this.grid_points[d].length;++e)f=this.grid_points[d][e].index,g=this.grid_points[d+1][e].index,a.moveTo(this.curr_xy[2*f],this.curr_xy[2*f+1]),a.lineTo(this.curr_xy[2*g],this.curr_xy[2*g+1]);a.closePath(),a.stroke()}var h;for(d=0;d<this.grid_points.length;++d)for(e=0;e<this.grid_points[d].length;++e)if(f=this.grid_points[d][e].index,0!==this.point_status[f]||1!==this.show_only_valid){var i=.2;if(this.grid_points[d][e].is_valid?(h=Math.round(this.grid_points[d][e].num_good/this.iteration*255),a.fillStyle="rgb(0,0,"+h+")",c(a,this.curr_xy[2*f],this.curr_xy[2*f+1],i)):(h=0,i=3,a.fillStyle="rgb(255,0,0)",c(a,this.curr_xy[2*f],this.curr_xy[2*f+1],i)),b.show_affine_error){var j=this.grid_points[d][e].error,k=5;j>k&&(j=k),0>j&&(j=0),j=Math.round(j/k*255),a.fillStyle="rgb("+j+","+(255-j)+",0)",c(a,this.curr_xy[2*f],this.curr_xy[2*f+1],4)}if(b.show_velocity&&this.time_history.length>1){var l=this.curr_xy[2*f]-this.prev_xy[2*f],m=this.curr_xy[2*f+1]-this.prev_xy[2*f+1],n=Math.sqrt(l*l+m*m);n>10&&(n=10),n/=10,a.strokeStyle="rgb("+n+","+(1-n)+",0)",a.beginPath(),a.moveTo(this.curr_xy[2*f],this.curr_xy[2*f+1]),a.lineTo(this.curr_xy[2*f]+3*l,this.curr_xy[2*f+1]+3*m),a.closePath(),a.stroke()}}}},this.fix_large_flow=function(a){if(this.grid_points&&0!==this.grid_points.length&&1!==this.grid_points.length&&1!==this.grid_points[0].length){var b,c,d,e,f,g,h,i,j=0;for(b=0;b<this.grid_points.length;++b)for(c=0;c<this.grid_points[b].length;++c)if(d=this.grid_points[b][c].index,e=this.curr_xy[2*d],f=this.curr_xy[2*d+1],g=this.prev_xy[2*d],h=this.prev_xy[2*d+1],i=Math.sqrt((e-g)*(e-g)+(f-h)*(f-h)),i>a){var k=e-g,l=f-h;k=k/i*a,l=l/i*a,this.curr_xy[2*d]=g+k,this.curr_xy[2*d+1]=h+l,j++}}}}function h(c,d,e){if(console.log("GridTracker initializing"),a?(G=new profiler,G.add("grayscale_time"),G.add("image_pyramid_time"),G.add("optical_flow_time")):G=null,G)for(var f=0;f<G.timers.length;++f){var g=G.timers[f];H[g[0]]=g[1].get_runtime()+"ms"}if(b){L=new dat.GUI,L.domElement.parentElement.style.zIndex=10,L.closed=!0;var h=L.addFolder("Tracker Parameters");h.add(H,"win_size",7,100).step(1),h.add(H,"max_iterations",3,30).step(1),h.add(H,"epsilon",.001,.1).step(.0025),h.add(H,"min_eigen",.001,.01).step(.0025),h.add(H,"NX",1,100).step(1),h.add(H,"NY",1,100).step(1),h.add(H,"skip",3,100).step(1);var i=L.addFolder("Display Parameters");i.add(H,"show_velocity"),i.add(H,"show_valid_frequency"),i.add(H,"show_affine_error"),i.add(H,"show_only_valid"),i.add(H,"apply_xform"),i.add(H,"max_displacement",0,300).step(1),i.add(H,"show_boxes"),i.add(H,"heart_beat",0,100).step(1),i.add(H,"require_detections"),L.add(H,"show_grid"),L.add(H,"require_detections"),L.add(H,"enable_grid");var j=L.addFolder("Timing");if(G){j.add(H,"fps").listen();for(var k=0;k<G.timers.length;++k){var l=G.timers[k];j.add(H,l[0]).listen()}}}else L=null;M=e,N=d,O=c,P=M.getContext("2d"),P.fillStyle="rgb(0,255,0)",P.strokeStyle="rgb(255,0,0)",I.allocate(O,N,jsfeat.U8_t|jsfeat.C1_t),J.allocate(O,N,jsfeat.U8_t|jsfeat.C1_t)}function i(a){a!==C&&(A=new Float32Array(2*a),B=new Float32Array(2*a),C=a,D=new Uint8Array(a),E=new Array(a),F=new Array(a))}function j(){for(var a=0,b=0;b<x.length;++b)for(var c=0;c<x[b].point_count;++c)A[2*a]=x[b].prev_xy[2*c],A[2*a+1]=x[b].prev_xy[2*c+1],B[2*a]=x[b].curr_xy[2*c],B[2*a+1]=x[b].curr_xy[2*c+1],D[a]=x[b].point_status[c],E[a]=b,F[a]=c,a++}function k(){for(var a=0;C>a;++a){var b=E[a],c=F[a];x[b].prev_xy[2*c]=A[2*a],x[b].prev_xy[2*c+1]=A[2*a+1],x[b].curr_xy[2*c]=B[2*a],x[b].curr_xy[2*c+1]=B[2*a+1],x[b].point_status[c]=D[a]}}function l(a,b){if(!a||!b)return!1;for(var c=0;c<a.length;++c)if(a[c]!==b[c])return!1;return!0}function m(a,b){if(H.enable_grid&&!(K&&l(K.data,a.data)||(K=a,H.require_detections===!0&&0===z.length||0===x.length))){G&&G.new_frame();var c=J;J=I,I=c;var d;for(G&&G.start("grayscale_time"),jsfeat.imgproc.grayscale(a.data,I.data[0].data),G&&G.stop("grayscale_time"),G&&G.start("image_pyramid_time"),I.build(I.data[0],!0),G&&G.stop("image_pyramid_time"),G&&G.start("optical_flow_time"),d=0;d<x.length;++d)x[d].pre_track();for(j(),jsfeat.optical_flow_lk.track(J,I,A,B,C,0|H.win_size,0|H.max_iterations,D,H.epsilon,H.min_eigen),k(),d=0;d<x.length;++d){if(H.apply_xform){var e=x[d].xform_errors();x[d].fix_large_flow(H.max_displacement),x[d].apply_xform_to_current(e,H.max_displacement)}x[d].add_to_history(b)}for(G&&G.stop("optical_flow_time"),d=0;d<z.length;++d)z[d]=n(z[d]);if((x[0].time_history.length===w||Q%H.heart_beat===0)&&r(b),G){H.fps=G.log();for(var f=0;f<G.timers.length;++f){var g=G.timers[f];H[g[0]]=g[1].get_runtime()+"ms"}}Q+=1}}function n(a){return x[0].move_bb(a)}function o(){if(P.clearRect(0,0,M.width,M.height),H.enable_grid&&(0!==H.show_grid||0!==H.show_boxes)){P.save(),P.scale(M.width/O,M.height/N);var a;if(H.show_grid)for(a=0;a<x.length;++a)x[a].draw_grid(P,H);if(H.show_boxes)for(a=0;a<z.length;++a)z[a].line_width=3,z[a].fill="rgba(255,0,0,.8)",z[a].color="rgba(255,0,0,.8)",z[a].draw(P);P.restore()}}function p(a,b){var c=a;if(0===x.length)return void console.log("WARNING: not adding bb because there are no grids");z=z.filter(function(b){return b.name!==a.name});var d={};if(b?(y.push(x[0]),d=new Detection(c.name,c.score,c.bb[0],c.bb[1],c.bb[2],c.bb[3]),d.line_width=1,c=q(d,b),null===c&&console.log("error, not found in history"),y.pop()):b=x[0].time_history[x[0].time_history.length-1],c.x1)z.push(d);else try{d=new Detection(c.name,c.score,c.bb[0],c.bb[1],c.bb[2],c.bb[3]),d.line_width=1,z.push(d)}catch(e){console.log(e)}for(var f=null,g=0;g<v.length;++g)if(v[g].name===c.name&&v[g].time===b){f=g;break}null!==f&&v.splice(f,1)}function q(a,b){var c,d,e;for(c=y.length-1;c>=0;c--)if(d=y[c].propagate_det(a,b),null!==d)return c===y.length-1?d:(e=y[c].time_history[y[c].time_history.length-1],q(d,e));return d}function r(a){if(1===x.length){y.push(x[0]);var b=_.min(v.map(function(a){return a.time}));y=y.filter(function(a){return a.time_history[a.time_history.length-1]>b})}else if(0!==x.length)throw"Too many grids";x.splice(0,1);var c=new Detection("",1,H.win_size,H.win_size,O-H.win_size,N-H.win_size);x.push(new g(c,H.NX,H.NY)),x[x.length-1].add_to_history(a),i(H.NX*H.NY*x.length)}function s(a,b){v.push({name:a,time:b})}function t(a){try{z=z.filter(function(b){return b.name!==a.name})}catch(b){console.log("WARNING: could not remove box")}0===z.length&&r(0)}function u(a){for(var b=M.width/O,c=M.height/N,d=0;d<z.length;++d)if(z[d].name===a){var e=z[d],f={x:e.x*b,y:e.y*c,x1:e.x1*b,y1:e.y1*c,x2:e.x2*b,y2:e.y2*c,trackerWidth:M.width,trackerHeight:M.height};return f}return null}var v=[],w=100,x=[],y=[],z=[],A=[],B=[],C=0,D=[],E=[],F=[],G=null,H={};H.win_size=15,H.max_iterations=3,H.epsilon=.01,H.min_eigen=.001,H.NX=20,H.NY=20,H.skip=10,H.show_velocity=!1,H.show_valid_frequency=!0,H.show_affine_error=!1,H.show_grid=!1,H.show_only_valid=!1,H.apply_xform=!1,H.max_displacement=100,H.show_boxes=!0,H.heart_beat=0,H.require_detections=!0,H.fps="",H.enable_grid=!0;var I=new jsfeat.pyramid_t(3),J=new jsfeat.pyramid_t(3),K=null,L=null,M=null,N=null,O=null,P=null,Q=0;return this.set_dims=function(a,b){(a!==this.width||b!==this.height)&&(this.width=a,this.height=b,delete this.curr_img_pyr,delete this.prev_img_pyr,this.curr_img_pyr=new jsfeat.pyramid_t(3),this.prev_img_pyr=new jsfeat.pyramid_t(3),this.curr_img_pyr.allocate(this.width,this.height,jsfeat.U8_t|jsfeat.C1_t),this.prev_img_pyr.allocate(this.width,this.height,jsfeat.U8_t|jsfeat.C1_t))},{initialize_canvas:h,initialize_grid:r,tracker_update:m,draw_all:o,add_bb:p,remove_bb:t,get_bb:u,add_request:s}},function(a){a.compatibility=function(){"use strict";var b=0,c=!0,d=a.URL||a.webkitURL,e=function(c,d){var e=a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||function(c){var d=(new Date).getTime(),e=Math.max(0,16-(d-b)),f=a.setTimeout(function(){c(d+e)},e);return b=d+e,f};return e.call(a,c,d)},f=function(b){var c=a.cancelAnimationFrame||function(a){clearTimeout(a)};return c.call(a,b)},g=function(b,c,d){var e=a.navigator.getUserMedia||a.navigator.mozGetUserMedia||a.navigator.webkitGetUserMedia||a.navigator.msGetUserMedia||function(a,b,c){c()};return e.call(a.navigator,b,c,d)},h=function(){var a=new ArrayBuffer(8),b=new Uint32Array(a);return b[0]=4278190080,c=!0,255===a[0]&&(c=!1),c};return{URL:d,requestAnimationFrame:e,cancelAnimationFrame:f,getUserMedia:g,detectEndian:h,isLittleEndian:c}}()}(window);var stopwatch=function(){"use strict";function a(){this.start_time=0,this.stop_time=0,this.run_time=0,this.running=!1}return a.prototype.start=function(){this.start_time=(new Date).getTime(),this.running=!0},a.prototype.stop=function(){this.stop_time=(new Date).getTime(),this.run_time=this.stop_time-this.start_time,this.running=!1},a.prototype.get_runtime=function(){return this.run_time},a.prototype.reset=function(){this.run_time=0},a}(),ring_buffer=function(){"use strict";function a(a){this.arr=new Int32Array(a),this.begin=0,this.end=-1,this.num_el=0,this.arr_size=a}return a.prototype.push_back=function(a){this.num_el<this.arr_size?(this.end++,this.arr[this.end]=a,this.num_el++):(this.end=(this.end+1)%this.arr_size,this.begin=(this.begin+1)%this.arr_size,this.arr[this.end]=a)},a.prototype.get=function(a){return this.arr[(this.begin+a)%this.arr_size]},a.prototype.size=function(){return this.num_el},a}(),profiler=function(){"use strict";function a(){this.fps=0,this.timers=[],this.frame_timer=new stopwatch}var b=0,c=new ring_buffer(20);return a.prototype.add=function(a){this.timers.push([a,new stopwatch])},a.prototype.new_frame=function(){++b;var a=0,d=0|this.timers.length;for(a=0;d>a;++a){var e=this.timers[a][1];e.reset()}if(b>=1){this.frame_timer.stop(),c.push_back(this.frame_timer.get_runtime());var f=c.size(),g=0;for(a=0;f>a;++a)g+=c.get(a);this.fps=f/g*1e3,this.frame_timer.start()}},a.prototype.find_task=function(a){var b=0|this.timers.length,c=0;for(c=0;b>c;++c){var d=this.timers[c];if(d[0]===a)return d}return null},a.prototype.start=function(a){var b=this.find_task(a);b[1].start()},a.prototype.stop=function(a){var b=this.find_task(a);b[1].stop()},a.prototype.log=function(){var a=(0|this.timers.length,"FPS: "+this.fps.toFixed(2));return a},a}(),_vmx_object_or_array,_vmx_is_encoded_image,_vmx_array_difference,_vmx_naive_smoothing,_vmx_get_computed_style,_vmx_clean_dirty_sessionId,image_data_to_dataurl,Base64,VmxMaxLengthArray;!function(){function a(a,b,c){void 0===c&&(c=.35);var d,e,f,g,h,i,j,k,l,m;return d=2*Math.abs(a.x1-b.x1),h=a.x2-a.x1,i=b.x2-b.x1,e=h+i,f=2*Math.abs(a.y1-b.y1),j=a.y2-a.y1,k=b.y2-b.y1,g=j+k,e>d&&g>f?(l=d/((a.w+b.w)/2),m=f/((a.h+b.h)/2),l+m>c?!0:!1):!0}_vmx_object_or_array=function(a){return a instanceof Array||a instanceof Object?!0:void 0},_vmx_is_encoded_image=function(a){if("string"!=typeof a)return!1;var b="data:image/jpeg;base64";return a.substring(0,b.length)===b?!0:!1},_vmx_array_difference=function(a,b,c){var d={};return b.forEach(function(a){d[a[c]]=a}),a.filter(function(a){return!(a[c]in d)})},_vmx_clean_dirty_sessionId=function(a){return"sessions/"===a.substring(0,9)&&(a=a.substring(9)),a},VmxMaxLengthArray=function(a){if("number"!=typeof a)throw{name:"vmx_maxlength_array type error",message:'Exepected `number`, received + "'+typeof a+'"'};return this.maxlength=a,this.queue=[],this},VmxMaxLengthArray.prototype.val=function(){return this.queue},VmxMaxLengthArray.prototype.add=function(a){return this.queue.unshift(a),this.queue.length>this.maxlength&&(this.queue=this.queue.splice(0,this.maxlength)),this},VmxMaxLengthArray.prototype.clear=function(){return this.queue=[],this},_vmx_naive_smoothing=function(b,c,d){if(a(b,c,.5))return d.clear(),c;var e="rgba(199,21,133,1)",f=d.val().length,g=new Date,h=new Detection(c.cls,c.score,d.val().map(function(a){return a.x1}).reduce(function(a,b){return a+b})/f,d.val().map(function(a){return a.y1}).reduce(function(a,b){return a+b})/f,d.val().map(function(a){return a.x2}).reduce(function(a,b){return a+b})/f,d.val().map(function(a){return a.y2}).reduce(function(a,b){return a+b})/f,"#00A",e,g);return h},_vmx_get_computed_style=function(a,b){return document.defaultView.getComputedStyle(a,null).getPropertyValue(b)},Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b,c,d,e,f,g,h,i="",j=0;for(a=Base64._utf8_encode(a);j<a.length;)b=a.charCodeAt(j++),c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return i},decode:function(a){var b,c,d,e,f,g,h,i="",j=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");j<a.length;)e=this._keyStr.indexOf(a.charAt(j++)),f=this._keyStr.indexOf(a.charAt(j++)),g=this._keyStr.indexOf(a.charAt(j++)),h=this._keyStr.indexOf(a.charAt(j++)),b=e<<2|f>>4,c=(15&f)<<4|g>>2,d=(3&g)<<6|h,i+=String.fromCharCode(b),64!==g&&(i+=String.fromCharCode(c)),64!==h&&(i+=String.fromCharCode(d));return i=Base64._utf8_decode(i)},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b},_utf8_decode:function(a){var b,c,d,e,f,g="";for(b=c=d=e=0;b<a.length;)c=a.charCodeAt(b),128>c?(g+=String.fromCharCode(c),b++):c>191&&224>c?(e=a.charCodeAt(b+1),g+=String.fromCharCode((31&c)<<6|63&e),b+=2):(e=a.charCodeAt(b+1),f=a.charCodeAt(b+2),g+=String.fromCharCode((15&c)<<12|(63&e)<<6|63&f),b+=3);return g}},image_data_to_dataurl=function(a){var b=document.createElement("canvas");return b.width=a.width,b.height=a.height,b.getContext("2d").putImageData(a,0,0),b.toDataURL(b)}}(),angular.module("vmx.services").factory("vmxapi",["$modal","vmxutils","vmxglobals",function(a,b,c){function d(){return"function"!=typeof VMX.cron?void window.clearInterval(h):void VMX.cron()}function e(){try{var a=document.getElementById("magic-canvas");document.body.removeChild(a)}catch(b){}}var f,g,h,i=function(){VMX.config.useMagicCanvas&&(j(),VMX.getMagicCanvas=function(){return f?f:void(f=document.getElementById("magic-canvas"))},VMX.getMagicContext=function(){return g?g:void(g=f.getContext("2d"))}),VMX.getSnapshot=function(){return b.extract_image(c.g.last_image)},h=window.setInterval(d,500)},j=function(){var b=a.open({templateUrl:"static/partial/vmxapi-magic-canvas-modal.html",windowClass:["vmx-magic-canvas-modal"],controller:["$scope","$modalInstance",function(a,b){a.cancel=function(){b.dismiss("cancel")}}]});b.result.then(function(){})},k=function(){VMX={},VMX.config={},VMX.storage={},e(),f=g=null};return{reset:k,populate:i}}]),angular.module("vmx.services").factory("vmxappcode",["$http","$q","vmxtracker","vmxglobals","VmxDetectorProviderX",function(a,b,c,d,e){function f(a){i=a,l=new Function("detections",a)}function g(a){"function"==typeof a&&(l=a)}function h(a){var b={detections:a.objects};vmxApi.processServerResponse(b)}var i,j,k="",l=null,m=[],n=!1,o=function(a){if(l&&n)try{l(a)}catch(b){console.log(b),console.log(b.stack)}};return e.addResponseHook(function(a,b){a=a,h(b),o(b.objects)}),vmxApi.fn.getSmooth=function(){return c.get_bb(this.selector)},vmxApi.getDimensions=function(){return{width:d.g.width,height:d.g.height}},{processRequest:h,set_entry_function_direct:g,set_execute_flag:function(a){n=a},get_execute_flag:function(){return n},get_apps:function(){var c=b.defer();return a.get(k+"apps").success(function(a){m=a,c.resolve(a)}).error(function(a,b,d,e){console.log("error"),console.log([a,b,d,e]),c.resolve([])}),c.promise},set_app:function(a){return j=m[a],f(j.value.callback),j},delete_app:function(c){var d=m[c],e=b.defer();return a["delete"](k+"apps/"+d.key).success(function(a){console.log(a),e.resolve(a)}),e.promise},save_app:function(){var b=[];console.log(j);for(var c=0;c<j.value.files.length;++c){var d=j.value.files[c];b.push({appfile_name:d.name,appfile_body:d.body})}var e={app_name:j.value.name,app_callback:j.value.callback,files:b};a.post(k+"apps/"+j.key,e).success(function(a){console.log("Successful update4??!?"),console.log(a)}).error(function(a,b,c,d){console.log("error trying to save..."),console.log([a,b,c,d])})},new_app:function(c){var d=b.defer(),e={app_name:c,app_callback:"//This comment should have more info",files:[]};return a.post(k+"apps",e).success(function(a){console.log("Successful made new???"),console.log(a),m.push(a),j=a,d.resolve(j)}).error(function(a,b,c,d){console.log("error trying to makenew......"),console.log([a,b,c,d])}),d.promise},save_file:function(a,b){j.value.files[a]=b},get_file:function(a){return j.value.files[a]},get_files:function(){return j.value.files},delete_file:function(a){j.value.files.splice(a,1)},get_callback:function(){return j.value.callback},set_entry:f,execute:o}}]),angular.module("vmx.services").factory("vmxboxes",["VmxDetectorProviderX",function(a){var b={},c="rgb(60, 181, 33)",d="rgb(205, 2, 0)",e=function(a,c){"object"!=typeof b[a]&&(b[a]=[]),b[a].push(c)};a.addStopHook(function(a){f(a.connection.id)}),a.addResponseHook(function(a,b){f(a.connection.id);var g=0,h=a.params.get("display_threshold");for(var i in b.objects)if(b.objects[i].score>h||a.params.get("display_top_detection")&&1===g){var j=[];j=b.objects[i].score>1?c:b.objects[i].score<-1?d:"rgba(255,255,0,.5)";var k=new Date,l=new Detection(b.objects[i].name,b.objects[i].score,b.objects[i].bb[0],b.objects[i].bb[1],b.objects[i].bb[2],b.objects[i].bb[3],"#00A",j,k,b.objects[i].ilearn_class);e(a.connection.id,l),a.prev_box=l}});var f=function(a){b[a]=[]},g=function(){var a=[];for(var c in b)a=a.concat(b[c]);return a};return{list:g,reset:f,add:e}}]),angular.module("vmx.services").factory("vmxconnections",["$q","$http",function(a,b){var c=[],d=SERVER+"session",e=function(c){console.log(c);var e=a.defer(),f={uuids:[]};return void 0!==c&&(f={uuids:[c],compiled:!1}),b.post(d,f).success(function(a){e.resolve(a.data.session_id)}).error(function(a,b){var c="";a.message&&(c=a.message),a.error&&(c=a.error),console.error("Error starting connection: ",c,b),e.reject(c)}),e.promise},f=function(){var e=a.defer();return b.get(d).success(function(a){if(a.error)return void console.log(a);for(var b=0,d=0;d<a.data.length;++d)void 0===a.data[d].model?b+=1:c[d-b]={id:a.data[d].session,model:a.data[d].model,status:0};c.splice(a.data.length),e.resolve(c)}).error(function(a){console.log("update error"),console.log(a)}),e.promise},g=function(){return c};return{create:e,update:f,list_cached:g}}]),angular.module("vmx.services").factory("VmxDetectorProviderX",["vmxglobals","vmxutils","VmxParamsProvider","$http","$q",function(a,b,c,d,e){function f(a){j("loadModel",a)}function g(a){j("start",a)}function h(a){j("stop",a)}function i(a){j("response",a)}function j(a,b){if("function"!=typeof b)throw"callback must be a function";var c=m[a+"Hooks"];if("function"!=typeof b)throw a+" is not a callback (try LoadModel,Start,Stop,Response)";c.push(b)}var k=[],l=50,m={responseHooks:[],addHooks:[],stopHooks:[],loadModelHooks:[]},n=function(){this.connection=null,this.waiter=!0,this.prev_box=null,this.params=c.getInstance(),this.pause=!1,this.response=null,this.short_response=null,this.last_time=0,this.started=!1,this.running=!1,this.paused=!1,this.loadModelHooks=[],this.startHooks=[],this.stopHooks=[],this.responseHooks=[],this.videoSrc=null};return n.prototype.addLoadModelHook=function(a){this.loadModelHooks.push(a)},n.prototype.setVideoSrc=function(a){this.videoSrc=a},n.prototype.addStartHook=function(a){this.startHooks.push(a)},n.prototype.addStopHook=function(a){this.stopHooks.push(a)},n.prototype.addResponseHook=function(a){this.responseHooks.push(a)},n.prototype.set_connection=function(a){this.connection=a,a&&(this.connection.id=b.vmx_clean_dirty_sessionId(this.connection.id)),this.params.syncWithServer(a)},n.prototype.start=function(){if(!this.videoSrc)throw"Detector must have an image stream to 'start'; maybe you want to detect a single frame?";this.waiter=!1,this.pause=!1,this.detectLoop()},n.prototype.stop=function(){this.paused=!0,this.fireStopHooks()},n.prototype.response=function(){return this.response},n.prototype.isDupTime=function(){var b=a.g.last_time,c=this;return c.last_time===b?(console.log("Detector called twice at the same time, pausing for "+l/1e3+"seconds"),l=1e3,setTimeout(function(){console.log("restarting detect loop"),c.detectLoop()},l),!0):void 0},n.prototype.cropWorthy=function(){return this.params.get("learn_mode")||!this.previous_detection||this.previous_detection.score<this.params.get("crop_threshold")?!1:!0},n.prototype.detectLoop=function(){var a=this,c=this.videoSrc.getImage(),d=c.width,e=c.height;if(this.paused)return void this.stop();if(!a.isDupTime()){var f,g=this.cropWorthy();f=g?b.extract_cropped_image(c,b.apply_crop_radius(this.previous_detection.bb,this.params.get("crop_radius"),d,e)):b.extract_cropped_image(c,null);var h=this.detect(f,{});h.then(function(b){var c=b;"server"===b.error?(console.error("Error communicating with vmx server, retrying in "+l/1e3+"seconds"),setTimeout(function(){l=1.2*l,console.error(b.data),a.detectLoop()},l)):(l=50,a.previous_detection=c.objects[0],c.objects.length>0&&a.fireResponseHook(c),a.detectLoop())})}},n.prototype.fireResponseHook=function(a){var b=m.responseHooks;for(var c in b)b[c](this,a)},n.prototype.fireStopHooks=function(a){var b=m.stopHooks;for(var c in b)b[c](this,a)},n.prototype.detect=function(c,f){if("undefined"==typeof f.type&&(f.type="default"),!this.connection)throw"No model or connection associated with this detector";var g=e.defer(),h={},i=new Date;h.ajax_start_time=i.getTime();var j,k={};this.last_time=a.g.last_time,j=this.params.clean_params(this.params.list_all_params());var l={};l.image="url"===f.type?c:c.dataURL,l.time=i.toISOString();var m=[l],n=SERVER+"session/"+this.connection.id,o={images:m,params:j};return d.post(n,o).error(function(a,b,c,d){console.log([a,b,c(),h,d]),1===a.error?console.error(a.message):console.error("Process image error",d);var e={error:"server",message:"error received trying to talk to VMX server",data:a,headers:c,status:b,config:d};g.resolve(e)}).success(function(a){try{k=a,k.ajax_time=((new Date).getTime()-h.ajax_start_time)/1e3,"url"!==f.type&&(k=b.undo_crop(k,c))}catch(d){console.log(["response/message",a,h]),console.log(d,d.message),k={},k.error=1}g.resolve(k)}),g.promise},{getInstance:function(){var a=new n;return k.push(a),a},running_detectors:function(){return k},addLoadModelHook:f,addStartHook:g,addStopHook:h,addResponseHook:i}}]),angular.module("vmx.services").factory("vmxgithub",["$q","$http","vmxappcode","vmxapi",function($q,$http,vmxappcode,vmxapi){var errors=[],load_repo=function(repoURL){var deferred=$q.defer(),url="githelper.php?repo="+encodeURIComponent(repoURL);return $http.get(url).success(function(response){errors=[],vmxapi.reset();for(var filepath in response)try{eval(response[filepath])}catch(e){errors.push({file:filepath,error:e.stack,line:e.lineNumber})}"function"==typeof VMX.callback?(vmxappcode.set_entry_function_direct(VMX.callback),vmxappcode.set_execute_flag(!0)):console.log(VMX),vmxapi.populate(VMX),deferred.resolve(!0)}),deferred.promise};return{load_git_repo:load_repo,current_errors:function(){return errors}}}]),angular.module("vmx.services").factory("vmxglobals",["$rootScope",function(a){function b(a,b){b===!0&&(l.save(),l.translate(k.width,0),l.scale(-1,1));var c=(new Date).getTime();a&&l.drawImage(a,0,0,k.width,k.height);var d=(new Date).getTime();return b===!0&&l.restore(),c=Math.round((c+d)/2),h.last_time=c,h.last_image=l.getImageData(0,0,k.width,k.height),k}function c(a){i=a,j=i.style.zIndex}function d(){h.selection_mode=!1,$("canvas").css("cursor","default"),i.style.zIndex=j,a.$apply()}function e(){h.selection_mode=!0,$("canvas").css("cursor","crosshair"),i.style.zIndex=1e3}function f(a){window.addEventListener("keypress",a,!1)}function g(a){window.removeEventListener("keypress",a,!1)}var h={};h.is_playing=!1,h.width=320,h.height=240,h.last_image=[],h.last_time=[],h.selection_mode=!1,h.columnPadding=15;var i=null,j=null,k=document.createElement("canvas");k.width=h.width,k.height=h.height;var l=k.getContext("2d");return{globals:h,g:h,set_image:b,set_selection_div:c,disable_selection_mode:d,enable_selection_mode:e,get_selection_mode:function(){return h.selection_mode},add_key_listener:f,remove_key_listener:g}}]),angular.module("vmx.services").factory("vmxipcam",["vmxglobals",function(a){function b(a){g=a,i.src=g}function c(){if(f){var b=new Image;b.src=g+"?q="+Math.random(),b.onload=function(){a.set_image(b),a.g.img=b,setTimeout(function(){c()},200)},++h}}function d(){f=!0,c()}function e(){f=!1}var f=!1,g="",h=0,i=document.createElement("img");return{play:d,stop:e,set_src:b,is_playing:function(){return f}}}]),angular.module("vmx.services").factory("vmxmodels",["$q","$http",function(a,b){function c(){return e}var d,e=[];d="undefined"!==SERVER?SERVER:"";var f=d+"model",g=function(){var c=a.defer();return b.get(f).success(function(a){for(var b=0;b<a.data.length;++b)e[b]=a.data[b];e.splice(a.data.length),c.resolve(a.data)}).error(function(a,b,c,d){console.log("error in get_models"),console.log([a,b,c,d])}),c.promise},h=function(c,d,e,g){for(var h=a.defer(),i=angular.copy(c),j=0;j<i.length;++j){delete i[j].$$hashKey,delete i[j].icon;for(var k=0;k<i[j].objects.length;++k)i[j].objects[k].name=d}var l={command:"create_model",images:i,params:g,session_id:e,name:d};return b.post(f,l).success(function(a){h.resolve(a)}),h.promise},i=function(c){var d=a.defer(),e={session_id:c};return b.put(f,e).success(function(a){a.error&&1===a.error?console.log("Error saving model inside session id",c):g(),d.resolve()}),console.log("after save model call"),d.promise};return{list:g,list_cached:c,create:h,save_current:i}}]),angular.module("vmx.services").factory("vmxparams",["VmxParamsProvider",function(a){var b=new a.getInstance;return b}]),angular.module("vmx.services").factory("VmxParamsProvider",["$http",function(a){var b=function(){this.makeDefaults(),this.container={},this.param_cache={}};return b.prototype.toggleLearning=function(){return this.named_params.learn_mode.value=!this.named_params.learn_mode.value,this.named_params.learn_mode.current_value=!this.named_params.learn_mode.current_value,this.update_parameters(),this.named_params.learn_mode.value},b.prototype.getLearningMode=function(){return this.named_params.learn_mode.value},b.prototype.syncWithServer=function(b){var c=this,d=SERVER+"session/"+b.id+"/params";a({method:"GET",url:d,timeout:1e5,async:!1}).error(function(a,b,c,d){console.error(["failed to get params from Server)",d,c,b,a])}).success(function(a){var b=a.data;return void 0===b?void console.error("Server returned empty response "+d):void c.update_parameters()})},b.prototype.makeDefaults=function(){this.ui_params=[{name:"crop_radius",alias:"Detection Crop Percentage",value:80,current_value:80,min_value:0,max_value:1e3,widget:"slider",group:["det"],learning_mode:!1,type:"integer"},{name:"crop_threshold",alias:"Detection Crop Threshold",value:-1,current_value:-1,min_value:-100,max_value:100,widget:"slider",group:["hide"],learning_mode:!1,type:"float"},{name:"display_threshold",alias:"Detection Display Threshold",value:-1,current_value:-1,min_value:-10,max_value:10,widget:"slider",group:["det"],learning_mode:!0,type:"float"},{name:"jpeg_quality",alias:"Image JPEG Quality",value:1,current_value:1,min_value:.1,max_value:1,widget:"slider",group:["hide"],learning_mode:!0,type:"float"},{name:"remove_smooth_below_threshold",alias:"Remove smooth box below display threshold",value:!0,current_value:!0,widget:"checkbox",group:["det"],learning_mode:!0,type:"bool"},{name:"display_top_detection",alias:"Display Top Detection",value:!1,current_value:!1,widget:"checkbox",group:["hide"],learning_mode:!0,type:"bool"}],this.detect_params=[{name:"max_windows",alias:"Detector Quality",value:10,current_value:10,min_value:1,max_value:3e3,widget:"slider",group:["det"],learning_mode:!0,type:"integer"},{name:"learn_mode",alias:"Learning Mode",value:!1,current_value:!1,widget:"checkbox",group:["hide"],learning_mode:!0,type:"bool"},{name:"learn_iterations",alias:"# of Learning Iterations",value:10,current_value:10,min_value:0,max_value:1e3,widget:"slider",group:["det"],learning_mode:!0,type:"integer"},{name:"learn_threshold",alias:"Learning Update Threshold",value:0,current_value:0,min_value:-10,max_value:10,widget:"slider",group:["det"],learning_mode:!0,type:"float"},{name:"detect_max_overlap",alias:"Maximum Overlap Threshold",value:.3,current_value:.3,min_value:0,max_value:.7,widget:"slider",group:["det"],learning_mode:!0,type:"float"},{name:"learn_max_positives",alias:"# of Learning Positives",value:1,current_value:1,min_value:0,max_value:100,widget:"slider",group:["det"],learning_mode:!0,type:"integer"},{name:"detect_add_flip",alias:"Left-Right Image Flip",value:!1,current_value:!1,widget:"checkbox",group:["det"],learning_mode:!0,type:"bool"},{name:"levels_per_octave",alias:"# of Pyramid Levels",value:10,current_value:10,min_value:1,max_value:10,widget:"slider",group:["hide"],learning_mode:!0,type:"integer"},{name:"max_image_size",alias:"Maximum Image Size",value:320,current_value:320,min_value:100,max_value:2e3,widget:"slider",group:["hide"],learning_mode:!0,type:"integer"}],this.init_params=[{name:"initialize_max_cells",alias:"Initial Object Max Size",value:12,current_value:12,min_value:2,widget:"slider",group:["init"],max_value:24,learning_mode:!0,type:"integer"},{name:"cell_size",alias:"Cell Size (pixels)",value:8,current_value:8,min_value:2,widget:"slider",group:["init","det"],max_value:16,learning_mode:!0,type:"integer"},{name:"initialize_add_flip",alias:"Initialize with Left-Right Flips",value:!0,current_value:!0,widget:"checkbox",group:["init"],learning_mode:!0,type:"bool"}],this.named_params={},this.named_ui_params={},this.named_detect_params={},this.named_init_params={},this.generate_named_parameters(),this.starting_params=angular.copy(this.named_params)
},b.prototype.get=function(a){return this.named_params[a].value},b.prototype.list_all_params=function(){return this.named_params},b.prototype.clean_params=function(a){var b={};for(var c in a){var d=a[c].value;null!=this.starting_params[c]&&(b[c]=d)}return b},b.prototype.generate_named_parameters=function(){for(var a=0;a<this.ui_params.length;a++)this.named_params[this.ui_params[a].name]=this.named_ui_params[this.ui_params[a].name]=this.ui_params[a];for(a=0;a<this.detect_params.length;a++)this.named_params[this.detect_params[a].name]=this.named_detect_params[this.detect_params[a].name]=this.detect_params[a];for(a=0;a<this.init_params.length;a++)this.named_params[this.init_params[a].name]=this.named_init_params[this.init_params[a].name]=this.init_params[a]},b.prototype.update_parameters=function(){this.update_parameters_one(this.ui_params),this.update_parameters_one(this.detect_params),this.update_parameters_one(this.init_params),this.generate_named_parameters(),this.named_params.learn_mode.value===!0?(this.named_params.display_top_detection.value=!0,this.named_params.display_top_detection.current_value=!0,console.log("making dtd true")):(this.named_params.display_top_detection.value=!1,this.named_params.display_top_detection.current_value=!1,console.log("making dtd false"))},b.prototype.update_parameters_one=function(a){for(var b in a){var c=a[b],d=c.current_value;("float"===c.type||"integer"===c.type)&&(d=parseFloat(c.current_value)),isNaN(d)&&(d=c.value),"integer"===c.type&&(d=Math.round(d)),("float"===c.type||"integer"===c.type)&&(d<c.min_value&&(d=c.min_value),d>c.max_value&&(d=c.max_value)),"bool"===c.type&&(1===d?d=!0:0===d&&(d=!1)),c.value=d,c.current_value=d}return a},{getInstance:function(){var a=new b;return a}}}]),angular.module("vmx.services").factory("vmxselector",function(){var a=[];return{add:function(b){a.push(b)},get_selections:function(){return a}}}),angular.module("vmx.services").factory("vmxtracker",["VmxDetectorProviderX",function(a){var b=new GridTracker(!0,!0);return a.addResponseHook(function(a,c){if(c&&c.objects&&0!==c.objects.length){var d=c.objects[0];d.score>a.params.get("display_threshold")?b.add_bb(angular.copy(d),a.last_time):a.params.get("remove_smooth_below_threshold")&&b.remove_bb(a.prev_box)}}),a.addStopHook(function(a){console.log("stop hook fired for"),console.log(a),b.remove_bb(a.prev_box)}),{initialize_canvas:b.initialize_canvas,initialize_grid:b.initialize_grid,tracker_update:b.tracker_update,draw_all:b.draw_all,add_bb:b.add_bb,get_bb:b.get_bb,remove_bb:b.remove_bb,add_request:b.add_request,params:b.params}}]),angular.module("vmx.services").factory("vmxui",function(){var a,b,c,d,e;a=b=c=d=e=!1;var f,g,h={};return h.response=!0,{container:h,toggle_parameters_visible:function(){return h.parameters=a=!a},toggle_detections_visible:function(){return h.detections=b=!b},toggle_editor_visible:function(){return h.editor=c=!c},toggle_response_visible:function(){return h.response=d=!d},toggle_modeler_visible:function(){return h.modeler=e=!e},parameters_visible:function(){return a},detections_visible:function(){return b},editor_visible:function(){return c},response_visible:function(){return d},modeler_visible:function(){return e},set_response:function(a){f=a},response:function(){return f},set_detections:function(a){g=a},get_detections:function(){return g}}}),angular.module("vmx.services").factory("vmxutils",["vmxglobals","vmxparams",function(vmxglobals,vmxparams){function _vmx_array_difference(a,b,c){var d={};return b.forEach(function(a){d[a[c]]=a}),a.filter(function(a){return!(a[c]in d)})}var g=vmxglobals.g,_vmx_clean_dirty_sessionId=function(a){return"sessions/"===a.substring(0,9)&&(a=a.substring(9)),a},_unix_to_date=function(a){return a},_undo_crop=function(obj,cropped_image){var counter=0;for(var i in obj.objects)if(counter++,obj.objects[i].bb)if(cropped_image.crop_bb){obj.objects[i].bb[0]=obj.objects[i].bb[0]+cropped_image.crop_bb[0],obj.objects[i].bb[1]=obj.objects[i].bb[1]+cropped_image.crop_bb[1],obj.objects[i].bb[2]=obj.objects[i].bb[2]+cropped_image.crop_bb[0],obj.objects[i].bb[3]=obj.objects[i].bb[3]+cropped_image.crop_bb[1];for(var q=0;4>q;++q)obj.objects[i].bb[q]=eval(obj.objects[i].bb[q].toFixed(2));obj.objects[i].image=_extract_image(cropped_image.full_image,obj.objects[i].bb)}else obj.objects[i].image=_extract_cropped_image(cropped_image.full_image);return obj},_apply_crop_radius=function(a,b,c,d){var e=a[2]-a[0],f=a[3]-a[1],h=c?c:g.width,i=d?d:g.height,j=[];return j[0]=Math.max(0,a[0]-b*e/100),j[1]=Math.max(0,a[1]-b*f/100),j[2]=Math.min(h,a[2]+b*e/100),j[3]=Math.min(i,a[3]+b*f/100),j},_extract_cropped_image=function(a,b,c,d){var e;c&&d&&(e=!0);var f,g,h,i,j=a.width,k=a.height,l=document.createElement("canvas"),m=l.getContext("2d");f=g=1,e?(h=c,i=d):(h=j,i=k),l.width=h,l.height=i,m.translate(h,0),m.scale(-1,1),m.putImageData(a,0,0),m.restore();var n;if(null!==b&&4===b.length){var o=document.createElement("canvas");o.width=Math.round(b[2]-b[0]),o.height=Math.round(b[3]-b[1]);var p=m.getImageData(b[0],b[1],o.width,o.height);o.getContext("2d").putImageData(p,0,0),n=o.toDataURL("image/jpeg",vmxparams.get("jpeg_quality"))}else n=l.toDataURL("image/jpeg",vmxparams.get("jpeg_quality")),b=[0,0,j,k];var q={};return q.dataURL=n,q.crop_bb=b,q.full_image=a,q},_extract_image=function(a,b){var c=document.createElement("canvas");b||(b=[0,0,a.width,a.height]),c.width=Math.max(1,Math.round(b[2]-b[0])),c.height=Math.max(1,Math.round(b[3]-b[1]));var d=document.createElement("canvas"),e=d.getContext("2d"),f=a.width,g=a.height;d.width=f,d.height=g,e.putImageData(a,0,0);var h=e.getImageData(b[0],b[1],c.width,c.height);c.getContext("2d").putImageData(h,0,0);var i=c.toDataURL("image/jpeg",vmxparams.get("jpeg_quality"));try{c.parentNode.removeChild(c)}catch(j){}return i};return{extract_image:_extract_image,apply_crop_radius:_apply_crop_radius,extract_cropped_image:_extract_cropped_image,undo_crop:_undo_crop,unix_to_date:_unix_to_date,vmx_clean_dirty_sessionId:_vmx_clean_dirty_sessionId,array_diff:_vmx_array_difference}}]),angular.module("vmx.services").provider("vmxconfig",function(){var a=null,b="https://beta.vision.ai/",c="/static/enter_license/dist/index.html";this.$get=function(){return{getVideoSrc:function(){return a},setVideoSrc:function(b){a=b},buyLink:function(){return b},enterLink:function(){return c}}},this.setVideoSrc=function(b){a=b}}),angular.module("vmx.services").factory("vmxImageStreamProvider",["vmxglobals",function(a){var b=function(){return new c},c=function(a){this.canvas=a};return c.prototype.getImage=function(){return a.g.last_image},{getInstance:b}}]),angular.module("vmx.services").factory("checkLicense",["$http","$q","$modal",function(a,b,c){var d,e,f,g=SERVER+"check",h=function(){var c=b.defer();return a.get(g).success(function(a){d=a.licensed?!0:!1,e=!1,c.resolve(d)}).error(function(a){d=!1,e=!0,f=a.error,c.resolve(d)}),c.promise},i=function(){return void 0!==d?d:!1},j=function(){return void 0!==e?e:!1},k=function(){var a=c.open({backdrop:"static",templateUrl:"static/partial/modalCheckLicense.html",windowClass:["vmx-check-license-modal"],controller:["$scope","$modalInstance","vmxconfig",function(a,b,c){a.buyLink=c.buyLink(),a.enterLink=c.enterLink(),a.cancel=function(){b.close()},a.check=function(){a.spin=!0,h().then(function(c){var d=c;a.spin=!1,d&&b.close()}),delete window.runVmxLicenseCheck},window.runVmxLicenseCheck=a.check}]});a.result.then(function(){})},l=function(){var a=c.open({templateUrl:"static/partial/modalProblemWithVMX.html",windowClass:["vmx-check-license-modal"],controller:["$scope","$modalInstance",function(a,b){a.errorMessage=f,a.cancel=function(){b.close()}}]});a.result.then(function(){})};return h().then(function(){j()?l():i()||k()}),{runCheck:h,isLicensed:i,isError:j}}]),angular.module("vmx").directive("vmxAvailableDetectors",["vmxconnections","VmxDetectorProviderX","vmxipcam","vmxconfig",function(a,b,c,d){return{restrict:"E",require:"^vmxOverlayContent",templateUrl:"static/partial/vmxAvailableDetectors.html",controller:["$scope","$modal","vmxglobals",function(e,f,g){e.top_detectors=a.list_cached();var h=function(a){var b=f.open({templateUrl:"static/partial/modelLoaderModal.html",windowClass:["vmx-wide-modal"],controller:["$scope","$modalInstance","vmxmodels",function(a,b,c){c.list().then(function(b){a.models=b}),a.choose=function(a){b.close(a)},a.cancel=function(){b.dismiss("cancel")}}]});b.result.then(function(b){b&&a(b)})};e.choose_model=function(){return h(function(f){e.spinner=Ladda.create(document.querySelector(".detector-chooser-spinner")),e.spinner.start(),a.create(f.uuid).then(function(f){var h=f;g.g.is_playing=!0;var i=b.getInstance();if(a.update().then(function(a){e.all_available_connections=a;var b=a.filter(function(a){return-1!==a.id.indexOf(h)}).pop();b&&e.our_connections.push(b),i.set_connection(b),i.setVideoSrc(d.getVideoSrc()),i.start(),e.spinner.stop()}),i.set_connection({id:h}),c.is_playing()){var j=document.getElementById("ipcam");i.setVideoSrc(j),e.vid=j}e.our_detectors[h]=i})["catch"](function(){e.spinner.stop()})})},e.format=function(){return e.search&&e.search.model?e.search.model.name:""},e.addDetector=function(a){var f=a.id;if("sessions/"===f.substring(0,9)?f=f.substring(9):console.log(f.substring(0,8)),b.running_detectors().filter(function(a){return a.connection.id===f}).length>0)return void console.log("Not attaching session, it is already attached");g.g.is_playing=!0;var h=b.getInstance();if(h.set_connection(a),h.setVideoSrc(d.getVideoSrc()),e.our_connections.push(a),c.is_playing()){var i=document.getElementById("ipcam");e.vid=i}h.start(),e.our_detectors[f]=h,e.search=""}}]}}]),angular.module("vmx").directive("vmxCreateModel",["vmxglobals",function(a){return{restrict:"E",require:"^vmxOverlayContent",templateUrl:"static/partial/vmxCreateModel.html",link:function(b,c){c.parent().draggable({handle:".dragbar",stack:".dbar"}),b.$on("$destroy",function(){a.remove_key_listener()}),b.ladda_button=Ladda.create(document.querySelector("vmx-create-model #create_model_button")),$("#create_model_text").focus(function(){a.remove_key_listener(b.presser)}),$("#create_model_text").focusout(function(){a.add_key_listener(b.presser)})},controller:["$scope","vmxselector","vmxglobals","vmxmodels","vmxconnections","vmxparams","VmxDetectorProviderX","vmxconfig",function(a,b,c,d,e,f,g,h){d.list(),a.paramsObj=f,a.model_name="",a.container={},a.container.show_selections=!1,a.error_message="",a.presser=function(b){97===b.keyCode&&(console.log("(a)dd selection"),a.toggle_selection_mode(),a.$apply())},c.add_key_listener(a.presser),a.get_selection_mode=function(){return c.g.selection_mode},a.toggle_selection_mode=function(){c.g.selection_mode===!0?c.disable_selection_mode():c.enable_selection_mode()},a.is_valid_name=function(b){if(0===b.length)return a.error_message="Model name cannot be empty",!1;if(b.search(" ")>=0)return a.error_message="Model name cannot contain spaces",!1;if("none"===b)return a.error_message='Model name cannot be "none"',!1;var c=d.list_cached(),e=0===c.filter(function(a){return a.name===b}).length;return a.error_message=e?"":'Model name "'+b+'" already used',e},a.has_selections=function(){return b.get_selections().length>0},a.remove_selection=function(b){a.selections.splice(b,1),a.has_selections()||(a.error_message="Must have at least one selection")},a.has_selections()||(a.error_message="Must have at least one selection"),a.create_model=function(c){a.paramsObj.update_parameters(),a.params=a.paramsObj.clean_params(a.paramsObj.list_all_params()),a.is_valid_name(c)&&(a.ladda_button.start(),e.create().then(function(f){var i=f;console.log("sid is "+i),d.create(b.get_selections(),c,i,a.params).then(function(){}).then(function(){var b=g.getInstance();d.save_current(i).then(function(){e.update().then(function(c){var d=c.filter(function(a){return a.id===i}).pop();d?(b.set_connection(d),console.log(["create model",b]),b.setVideoSrc(h.getVideoSrc()),b.start(),a.ladda_button.stop(),a.ui.panels.createModel=!1):console.log("Problem: just created session, but could not find it")})})})})["catch"](function(b){console.log("Cannot create session, error:",b),a.ladda_button.stop()}))},a.selections=b.get_selections()}]}}]),angular.module("vmx").directive("vmxDebugPanel",function(){return{restrict:"E",require:"^vmxOverlayContent",templateUrl:"static/partial/vmxDebugPanel.html",link:function(a,b){b.parent().draggable({handle:".dragbar",stack:".dbar"})},controller:["VmxDetectorProviderX",function(a){a.addResponseHook(function(a,b){b.objects&&b.objects.length>=1&&(a.short_response=b.objects[0])})}]}}),angular.module("vmx").directive("vmxDetectorParam",function(){return{restrict:"E",require:"^vmxDetectorParams",templateUrl:"static/partial/vmxDetectorParam.html",link:function(a){a.param.slider_step="slider"===a.param.widget&&"float"===a.param.type?parseFloat((a.param.max_value-a.param.min_value)/100).toPrecision(2):1},controller:["$scope",function(a){a.$on("expandAll",function(b,c){a.paramcontainer.collapse=c})}]}}),angular.module("vmx").directive("vmxDetectorParams",function(){return{restrict:"E",require:"^vmxRunningDetectors",templateUrl:"static/partial/vmxDetectorParams.html",scope:{paramsObj:"=params",toInclude:"&",showbutton:"=showbutton"},controller:["$scope","vmxui",function(a,b){a.vmxui=b,a.$on("savingModeChange",function(b,c){a.saving_mode=c}),a.params=a.paramsObj.list_all_params(),a.update_button=void 0===a.showbutton?!0:a.showbutton,a.update_current_parameters=function(){a.paramsObj.update_parameters(),a.params=a.paramsObj.list_all_params(),a.$emit("updateButtonPressed")},a.collapse_state=!0,a.expand_all_params=function(){a.collapse_state=!a.collapse_state,a.$broadcast("expandAll",a.collapse_state)};var c=a.toInclude();console.log(c),console.log(a.toInclude(),a.params),console.log("controller $scode",a),a.update_current_parameters()}]}}),angular.module("vmx").directive("vmxDetectorThumbnail",function(){return{restrict:"E",templateUrl:"static/partial/vmxDetectorThumbnail.html",scope:{model:"=model"},controller:function(){}}}),angular.module("vmx").directive("vmxImageCrop",["$compile",function(a){return{restrict:"E",templateUrl:"static/partial/vmxImageCrop.html",scope:{"class":"=class",score:"=score",time:"@time",image:"@image"},link:function(b,c){a(c.contents())(b)}}}]),angular.module("vmx").directive("vmxGitPane",["vmxappcode","vmxgithub","vmxapi",function(a,b,c){return{restrict:"E",templateUrl:"static/partial/vmxGitPane.html",link:function(a,b){b.parent().draggable({handle:".dragbar",stack:".dbar"})},controller:["$scope",function(d){d.container={},d.container.errors=null,d.switches={},d.clear=function(){c.reset(),d.switches.run_code_switch=!1},d.repos=[{name:"PONG",repo:"https://github.com/gdoteof/vmxapp_pong.git"},{name:"Email on detect",repo:"https://github.com/gdoteof/vmxapp_email.git"},{name:"Hello World",repo:"https://github.com/gdoteof/vmxapp-helloworld.git"},{name:"Tweeter",repo:"https://github.com/gdoteof/vmxapp_tweet.git"},{name:"Counter",repo:"https://github.com/gdoteof/vmxapp_count.git"}],d.setrepo=function(a){d.gitrepo=a.repo},d.gitrepo="https://github.com/gdoteof/vmxapp-helloworld.git",d.$watch("switches.run_code_switch",function(b){a.set_execute_flag(b?!0:!1)}),d.load_git_repo=function(a){b.load_git_repo(a).then(function(a){a&&(d.container.errors=b.current_errors()),d.switches.run_code_switch=!0})}}]}}]),angular.module("vmx").directive("vmxJsonPane",["$compile",function(a){return{restrict:"E",scope:{data:"=binding"},link:function(b,c){var d="<ul>";d+="<li ng-repeat='(key,value) in data track by $index'>",d+='<div ng-if="object_or_array(value)">',d+='{{key}}: <vmx-json-pane binding="value"></vmx-json-pane>',d+="</div>",d+='<div ng-if="!object_or_array(value)">',d+="<div ng-if='is_encoded_image(value)'>",d+='<span><em>{{key}}</em> : <br/><img style="width:100px" ng-src="{{value}}"/>',d+="</div>",d+="<div ng-if='!is_encoded_image(value)'>",d+="<span><em>{{key}}</em> : {{value}}</span>",d+="</div>",d+="</div>",d+="</li>",d+="</ul>";var e=angular.element(d);a(e)(b),c.replaceWith(e)},controller:["$scope",function(a){a.object_or_array=_vmx_object_or_array,a.is_encoded_image=_vmx_is_encoded_image}]}}]),angular.module("vmx").directive("vmxOverlayContent",function(){return{restrict:"E",templateUrl:"static/partial/vmxOverlayContent.html",require:"^vmxOverlay",controller:["$scope","vmxglobals",function(a,b){a.selectionMode=b.get_selection_mode}]}}),angular.module("vmx").directive("vmxOverlay",function(){return{restrict:"E",templateUrl:"static/partial/vmxOverlay.html",controller:["$scope","VmxDetectorProviderX","vmxconnections",function(a,b,c){a.search=void 0,a.running_detectors=b.running_detectors(),a.ui={},a.ui.panels={availableDetectors:!0},c.update().then(function(b){a.all_available_connections=b}),a.our_connections=[],a.our_detectors=[],a.search=null}]}}),angular.module("vmx").directive("vmxOverlayToolbar",function(){return{restrict:"E",templateUrl:"static/partial/vmxOverlayToolbar.html",require:"^vmxOverlay",controller:["$scope",function(a){a.toggle=function(b){a.ui.panels[b]=!a.ui.panels[b]},a.panel_state=function(b){return void 0===a.ui.panels[b]||a.ui.panels[b]===!1?!1:!0}}]}}),angular.module("vmx").directive("vmxRunningDetectors",["vmxmodels","VmxDetectorProviderX",function(a,b){return{restrict:"E",templateUrl:"static/partial/vmxRunningDetectors.html",link:function(a,b){b.parent().draggable({handle:".dragbar",stack:".dbar"})},controller:["$scope","$modal",function(c,d){c.saving_mode=!1,c.toggle_learning_mode=function(a){c.running_detectors[a].params.toggleLearning()},c.$on("updateButtonPressed",function(){c.aggroSliderInit=!1}),c.save_model=function(b,d){c.saving_mode=!0,c.$broadcast("savingModeChange",!0);var e=Ladda.create(document.getElementById(d));e.start();var f=a.save_current(b.id);f.then(function(){e.stop(),c.saving_mode=!1,c.$broadcast("savingModeChange",!1)})},c.displayModelEditorModal=function(a){d.open({templateUrl:"static/partial/modelEditorModal.html",windowClass:"vmx-wide-modal",controller:["$scope","$modalInstance","vmxui","$http",function(b,c,d,e){b.update_status_number=0,b.container={},b.container.objects=[],b.objects_cache=[],b.reverse=!0,b.settings={},b.settings.max_positives=20,b.settings.max_negatives=20,b.settings.positives_order=1,b.settings.negatives_order=-1,b.settings.learn_iterations=10,b.toggle_modeler_visible=d.toggle_modeler_visible,b.$watch("vmxui.modeler()",function(a){b.modeler=a}),console.log("creating modeler pane");var f={changes:[],settings:b.settings};console.log(b.settings);var g="session/"+a.id+"/edit";e.post(g,f).success(function(a){b.container.objects=a.data,b.objects_cache=angular.copy(a.data),console.log("just got "+b.container.objects.length+" objects")}).error(function(a){b.container.objects=[],b.objects_cache=[],console.error("Error with Model Editor Response",a)}),console.log("done creating modeler pane"),b.modeler_changed=function(){if(b.objects_cache&&0!==b.objects_cache.length){for(var a=0;a<b.container.objects.length;++a)if(b.container.objects[a].class_label!==b.objects_cache[a].class_label)return!0;return!1}},b.submit_stuff=function(){for(var a=[],c=0;c<b.container.objects.length;++c)if(b.container.objects[c].class_label!==b.objects_cache[c].class_label){var d=angular.copy(b.container.objects[c]);delete d.image,a.push(d)}console.log("Submitting edit_model data",a),b.update_model(a)},b.update_model=function(c){var d={settings:b.settings,changes:c},f="session/"+a.id+"/edit",g=Ladda.create(document.querySelector("#update_model_button"));g.start(),e.put(f,d).success(function(a){console.log("edit_model finished with result",a),b.container.objects=a.data,b.objects_cache=angular.copy(a.data),console.log("just got "+b.container.objects.length+" objects"),g.stop()}).error(function(a){console.log("error with edit_model",a),g.stop()})},b.input="",b.ok=function(a){console.log("modal submitted",a),c.close(a)},b.cancel=function(){c.dismiss("cancel")}}]})},c.removeDetector=function(a,b){var d=c.running_detectors.splice(b,1).pop();d.stop()},b.addResponseHook(function(a,b){a.connection.model.num_pos=b.model.num_pos,a.connection.model.num_neg=b.model.num_neg,a.connection.model.end_time=b.model.end_time})}]}}]),angular.module("vmx").directive("vmxTracker",function(){return{restrict:"E",require:"^vmxVideo",templateUrl:"static/partial/vmxTracker.html",link:function(a,b){a.trackerId=a.toId("tracker",a.vname),a.addCanvas(b[0].children[0])},controller:["$scope","vmxtracker","vmxglobals",function(a,b,c){a.drawTrackerBoxes=function(){b.draw_all()},a.initialized=!1,a.$watch("g.is_playing",function(d){d===!0&&a.initialized===!1&&(a.initialized=!0,setTimeout(function(){a.tracker_canvas=document.getElementById(a.trackerId),b.initialize_canvas(c.g.width,c.g.height,a.tracker_canvas),b.initialize_grid(c.g.last_time),a.addPostFunction(function(){b.tracker_update(c.g.last_image,c.g.last_time)}),a.addPostFunction(b.draw_all)},400))})}]}}),angular.module("vmx").directive("vmxIpCam",function(){return{restrict:"E",require:"^vmxVideo",templateUrl:"static/partial/vmxIpCam.html",link:function(a,b){a.camId=a.toId("cam",a.vname),console.log("camId is ",a.camId),a.addCanvas(b[0].children[0])}}}),angular.module("vmx").directive("vmxVideo",["$window","vmxboxes","vmxselector","vmxglobals","vmxImageStreamProvider","checkLicense",function(a,b,c,d,e,f){return"evil"!==f&&console.log("Welcome to VMX"),{restrict:"E",templateUrl:"static/partial/vmxVideo.html",transclude:!0,link:function(a,b,c){var e=c.vname?c.vname:"vmx",f=c.width?c.width:"100%",g=c.height?c.height:"100%";b[0].style.width=f,b[0].style.height=g,console.log(b),console.log(f,g),console.log(d.g),a.videoId=a.toId("video",e),a.canvasId=a.toId("canvas",e),a.canvasList=[b[0].children[0].children[1].children[0]],a.vname=e,a.selection_div=b[0].children[0].children[1],d.set_selection_div(a.selection_div),a.color_fg="rgb(60, 181, 33)",a.color_bg="rgb(205, 2, 0)"},controller:["$scope","vmxglobals","$attrs","vmxutils","vmxipcam","$modal","vmxconfig",function(d,f,g,h,i,j,k){function l(){m=$("#"+t).width(),n=f.g.height/f.g.width*m,console.log(n);for(var a=0;a<d.canvasList.length;++a)d.canvasList[a].height=n,d.canvasList[a].width=m}var m,n;d.g=f.g;var o=void 0!==typeof g.vname?g.vname:"vmx";o="undefined"!=typeof o?o:"vmx",d.toId=function(a,b){return a.trim()+"-vmx-"+b.trim()};var p,q,r=null,s=null;d.player=[];var t=d.toId("video",o),u=d.toId("canvas",o);d.addCanvas=function(a){d.canvasList.push("string"==typeof a?document.getElementById(a):a),d.canvasList[d.canvasList.length-1].addEventListener("mousedown",d.getPosition,!1),d.canvasList[d.canvasList.length-1].addEventListener("mousemove",d.savePosition,!1)},d.post_functions=new Array(0),d.addPostFunction=function(a){d.post_functions.push(a)},angular.element(a).on("resize",function(){l()}),d.setupStream=function(){d.vid=document.getElementById(t);var a=e.getInstance(d.vid);k.setVideoSrc(a),d.canvas=document.getElementById(u),d.gCtx=d.canvas.getContext("2d"),d.gCtx.save(),d.gCtx.translate(m,0),d.gCtx.scale(-1,1),setTimeout(function(){d.vid.play(),l(),d.g.is_playing=!0,d.$apply(),compatibility.requestAnimationFrame(d.draw)},500)},d.callbackStreamIsReady=function(a){d.vid.src=compatibility.URL.createObjectURL(a),d.vid.style.visibility="visible",$vmx.init()},d.video_pause_play=function(){d.vid.paused===!0?d.vid.play():d.vid.pause()},d.external_source_modal=function(){var a=j.open({templateUrl:"static/partial/externalSourceModal.html",controller:["$scope","$modalInstance","$location",function(a,b,c){a.input="http://"+c.host()+":"+c.port()+"/random",a.ok=function(a){b.close(a)},a.cancel=function(){b.dismiss("cancel")}}]});a.result.then(function(a){a&&v(a)})};var v=function(a){i.set_src(a),i.play();var b=e.getInstance(d.vid);k.setVideoSrc(b),d.g.is_playing||w()},w=function(){d.canvas=document.getElementById(u),d.gCtx=d.canvas.getContext("2d"),d.g.is_playing=!0,d.canvas.addEventListener("mousedown",d.getPosition,!1),d.canvas.addEventListener("mousemove",d.savePosition,!1),compatibility.requestAnimationFrame(d.draw)};d.callbackStreamIsFail=function(a){console.log("Webcam access not allowed",a),d.external_source_modal()},setTimeout(function(){d.setupStream()},1),"function"==typeof navigator.webkitGetUserMedia?compatibility.getUserMedia({video:!0},d.callbackStreamIsReady,d.callbackStreamIsFail):d.callbackStreamIsFail(),d.draw=function(){compatibility.requestAnimationFrame(d.draw);for(var a,b=0;b<d.canvasList.length;++b)a=d.canvasList[b],a.getContext("2d").clearRect(0,0,a.width,a.height);for(f.g.img?(d.gCtx.clearRect(0,0,d.canvas.width,d.canvas.height),d.gCtx.drawImage(f.g.img,0,0,d.canvas.width,d.canvas.height)):d.vid&&f.set_image(d.vid,!0),d.gCtx.restore(),s=d.g.selection_mode,s&&d.drawSelection(d.gCtx),d.drawBoxes(d.gCtx),b=0;b<d.post_functions.length;++b)d.post_functions[b]()},d.drawBoxes=function(a,c){c||(c=b.list()),c.sort(function(a,b){return a.score>b.score}),a.save(),a.scale(a.canvas.width/f.g.width,a.canvas.height/f.g.height);var d;for(var e in c)d=c[e],d.draw(a);a.restore()},d.getPosition=function(a){if(d.g.selection_mode){var b=a.clientX,e=a.clientY,g=d.canvas;if(b-=g.getBoundingClientRect().left,b-=d.g.columnPadding,e-=g.getBoundingClientRect().top,void 0===typeof r||null===r)r={},r.x=b,r.y=e;else{var i=f.g.last_image,j=f.g.last_time,k=h.extract_image(i),l={};l.image=k,l.time=new Date(j).toISOString();var m=f.g.width/g.width,n=f.g.height/g.height,o=[],p={};p.name="_selection",p.bb=new Array(r.x*m,r.y*n,b*m,e*n),p.score=null,p.extra=null;var q;p.bb[0]>p.bb[2]&&(q=p.bb[0],p.bb[0]=p.bb[2],p.bb[2]=q),p.bb[1]>p.bb[3]&&(q=p.bb[1],p.bb[1]=p.bb[3],p.bb[3]=q),console.log(p.bb),p.icon=h.extract_image(i,p.bb),o.push(p),l.objects=o,c.add(l),d.$digest(),r=null,f.disable_selection_mode()}}},d.savePosition=function(a){if(d.g.selection_mode){p=a.clientX,q=a.clientY;var b=d.canvas;p-=b.getBoundingClientRect().left+d.g.columnPadding,q-=b.getBoundingClientRect().top}},d.drawSelection=function(a){return null==r?(a.lineWidth=1,a.strokeStyle=d.color_bg,a.beginPath(),a.moveTo(0,q),a.lineTo(a.canvas.width,q),a.closePath(),a.stroke(),a.beginPath(),a.moveTo(p,0),a.lineTo(p,a.canvas.height),a.closePath(),void a.stroke()):(a.lineWidth=5,a.strokeStyle=d.color_bg,a.strokeRect(r.x,r.y,p-r.x,q-r.y),a.fillStyle="rgba(225,225,225,0.4)",void a.fillRect(r.x,r.y,p-r.x,q-r.y))}}]}}]),angular.module("vmx.services").filter("classIs",function(){return function(a,b){return a.filter(function(a){return a.class_label===b})}}),angular.module("vmx.services").filter("includeParams",function(){return function(a,b){if(b&&b instanceof Array){var c={};for(var d in a)d&&(-1!==b.indexOf(d)||_.intersection(a[d].group,b).length)&&(c[d]=a[d]);a=c}return a}}),angular.module("vmx.services").filter("modelNameContains",function(){return function(a,b){return a?a.filter(function(a){return"none"!==a.model.name&&!b||-1!==a.model.name.indexOf(b)}):[]}}),angular.module("vmx.services").filter("scoreIs",function(){return function(a,b,c){var d;if("undefined"==typeof c||""===c)return a;switch(b){case"<":case"lt":d=function(a,b){return b>a};break;case">":case"gt":d=function(a,b){return a>b}}return a.filter(function(a){return d(a.score,c)})}}),angular.module("vmx.services").filter("stripSession",function(){return function(a){return a.replace("sessions/","")}});var $vmx={};$(document).ready(function(){{var a=angular.element(document).injector();a.get("vmxconnections")}$vmx.models=a.get("vmxmodels"),$vmx.connections=a.get("vmxconnections"),$vmx.detectorFactory=a.get("VmxDetectorProviderX"),$vmx.imageStreamProvider=a.get("vmxImageStreamProvider"),$vmx.defaultStream=$vmx.imageStreamProvider.getInstance(document.getElementById("video-vmx-vmx")),$vmx.appcode=a.get("vmxappcode"),$vmx.defaultDetector=$vmx.detectorFactory.getInstance(),$vmx.defaultDetector.setVideoSrc($vmx.defaultStream),$vmx.detect=$vmx.defaultDetector.detect});